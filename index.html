<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<meta http-equiv="Content-Security-Policy" content="default-src 'self'; script-src 'self' 'unsafe-inline' https://www.gstatic.com https://fonts.googleapis.com https://fonts.gstatic.com https://identitytoolkit.googleapis.com; connect-src https://*.firebaseio.com https://*.googleapis.com https://firestore.googleapis.com https://identitytoolkit.googleapis.com https://securetoken.googleapis.com; style-src 'self' 'unsafe-inline' https://fonts.googleapis.com; font-src https://fonts.gstatic.com;">
<meta name="referrer" content="no-referrer">
<title>TerraLex â€” GestiÃ³n de Propiedades</title>
<link href="https://fonts.googleapis.com/css2?family=Lato:wght@400;700;900&family=Playfair+Display:wght@400;600;700&family=DM+Sans:wght@300;400;500;600&display=swap" rel="stylesheet">
<style>
:root{--bg:#0b1519;--surface:#152530;--surface2:#1c3040;--border:#254050;--accent:#917860;--accent2:#b09070;--text:#f0ece4;--muted:#7a96a8;--danger:#c96e6e;--success:#6ec98a;--warning:#c9b96e;--info:#6ea0c9;}
*{box-sizing:border-box;margin:0;padding:0;}
body{font-family:'Lato',sans-serif;background:var(--bg);color:var(--text);min-height:100vh;}
.login-wrap{min-height:100vh;display:flex;align-items:center;justify-content:center;padding:24px;background:radial-gradient(ellipse at 30% 20%,rgba(201,169,110,0.07) 0%,transparent 60%);}
.login-box{width:420px;max-width:100%;}
.login-logo{text-align:center;margin-bottom:40px;}
.login-logo h1{font-family:'Playfair Display',serif;font-size:2.4rem;color:var(--accent);}
.login-logo p{color:var(--muted);font-size:0.85rem;margin-top:6px;letter-spacing:0.08em;text-transform:uppercase;}
.login-card{background:var(--surface);border:1px solid var(--border);border-top:3px solid var(--accent);border-radius:16px;padding:36px;}
.login-card h2{font-size:1.1rem;font-weight:600;margin-bottom:24px;}
.form-group{display:flex;flex-direction:column;gap:6px;margin-bottom:16px;}
label{font-size:0.75rem;font-weight:600;color:var(--muted);text-transform:uppercase;letter-spacing:0.07em;}
input,select,textarea{background:var(--bg);border:1px solid var(--border);border-radius:8px;padding:11px 14px;color:var(--text);font-family:'DM Sans',sans-serif;font-size:0.9rem;outline:none;transition:border-color 0.2s;width:100%;}
input:focus,select:focus,textarea:focus{border-color:var(--accent);}
select option{background:var(--surface);}
textarea{resize:vertical;min-height:80px;}
.btn{display:inline-flex;align-items:center;justify-content:center;gap:8px;padding:11px 20px;border-radius:8px;border:none;font-family:'Lato',sans-serif;font-size:0.9rem;font-weight:700;cursor:pointer;transition:all 0.2s;text-decoration:none;}
.btn-primary{background:var(--accent);color:#0f0e0c;width:100%;}
.btn-primary:hover{background:var(--accent2);}
.btn-ghost{background:transparent;color:var(--muted);border:1px solid var(--border);}
.btn-ghost:hover{color:var(--text);border-color:var(--muted);}
.btn-danger{background:rgba(201,110,110,0.15);color:var(--danger);border:1px solid rgba(201,110,110,0.3);}
.btn-sm{padding:7px 14px;font-size:0.8rem;}
.btn-xs{padding:4px 10px;font-size:0.75rem;}
.login-err{background:rgba(201,110,110,0.12);border:1px solid rgba(201,110,110,0.3);border-radius:8px;padding:10px 14px;font-size:0.83rem;color:var(--danger);margin-bottom:16px;display:none;}
.login-err.show{display:block;}
.app{display:none;}.app.visible{display:flex;min-height:100vh;}
.sidebar{width:240px;background:var(--surface);border-right:1px solid var(--border);display:flex;flex-direction:column;position:fixed;left:0;top:0;bottom:0;z-index:100;}
.logo{padding:24px 20px 18px;border-bottom:1px solid var(--border);}
.logo h1{font-family:'Playfair Display',serif;font-size:1.35rem;color:var(--accent);}
.logo span{color:var(--muted);font-size:0.68rem;letter-spacing:0.1em;text-transform:uppercase;display:block;margin-top:2px;}
.user-pill{margin:12px;background:var(--surface2);border-radius:10px;padding:10px 12px;display:flex;align-items:center;gap:10px;}
.user-avatar{width:32px;height:32px;border-radius:50%;background:rgba(201,169,110,0.2);display:flex;align-items:center;justify-content:center;font-size:0.8rem;font-weight:700;color:var(--accent);flex-shrink:0;}
.user-name{font-size:0.8rem;font-weight:600;flex:1;overflow:hidden;text-overflow:ellipsis;white-space:nowrap;}
.user-role{font-size:0.65rem;color:var(--muted);}
.logout-btn{background:none;border:none;color:var(--muted);cursor:pointer;padding:4px;border-radius:4px;}
.logout-btn:hover{color:var(--danger);}
.nav{flex:1;padding:12px 10px;}
.nav-item{display:flex;align-items:center;gap:10px;padding:10px 12px;border-radius:8px;cursor:pointer;color:var(--muted);font-size:0.875rem;font-weight:500;transition:all 0.2s;margin-bottom:2px;}
.nav-item:hover{background:var(--surface2);color:var(--text);}
.nav-item.active{background:rgba(201,169,110,0.12);color:var(--accent);}
.nav-item svg{width:16px;height:16px;flex-shrink:0;}
.nav-badge{background:var(--danger);color:white;font-size:0.62rem;font-weight:700;border-radius:999px;padding:1px 5px;margin-left:auto;}
.nav-label{font-size:0.67rem;font-weight:700;letter-spacing:0.1em;text-transform:uppercase;color:var(--muted);padding:14px 12px 5px;}
.main{margin-left:240px;flex:1;padding:30px 34px;}
.page{display:none;animation:fadeIn 0.2s ease;}.page.active{display:block;}
@keyframes fadeIn{from{opacity:0;transform:translateY(6px);}to{opacity:1;}}
.page-header{display:flex;align-items:flex-start;justify-content:space-between;margin-bottom:26px;gap:16px;}
.page-title{font-family:'Playfair Display',serif;font-size:1.75rem;}
.page-sub{color:var(--muted);font-size:0.85rem;margin-top:3px;}
.stats-grid{display:grid;grid-template-columns:repeat(4,1fr);gap:14px;margin-bottom:22px;}
.stat-card{background:var(--surface);border:1px solid var(--border);border-radius:12px;padding:18px 20px;}
.stat-label{color:var(--muted);font-size:0.72rem;font-weight:600;text-transform:uppercase;letter-spacing:0.08em;margin-bottom:7px;}
.stat-val{font-size:1.7rem;font-weight:600;line-height:1;}
.stat-sub{color:var(--muted);font-size:0.72rem;margin-top:5px;}
.stat-card.accent{border-color:rgba(201,169,110,0.3);}.stat-card.accent .stat-val{color:var(--accent);}
.stat-card.danger{border-color:rgba(201,110,110,0.3);}.stat-card.danger .stat-val{color:var(--danger);}
.stat-card.success{border-color:rgba(110,201,138,0.3);}.stat-card.success .stat-val{color:var(--success);}
.table-wrap{background:var(--surface);border:1px solid var(--border);border-radius:12px;overflow:hidden;}
.table-toolbar{padding:14px 18px;border-bottom:1px solid var(--border);display:flex;align-items:center;justify-content:space-between;gap:12px;flex-wrap:wrap;}
.search-input{background:var(--bg);border:1px solid var(--border);border-radius:8px;padding:8px 13px;color:var(--text);font-family:'DM Sans',sans-serif;font-size:0.85rem;width:220px;outline:none;}
.search-input::placeholder{color:var(--muted);}
.search-input:focus{border-color:var(--accent);}
table{width:100%;border-collapse:collapse;}
thead tr{border-bottom:1px solid var(--border);}
th{padding:11px 18px;text-align:left;font-size:0.7rem;font-weight:700;text-transform:uppercase;letter-spacing:0.08em;color:var(--muted);}
td{padding:13px 18px;font-size:0.865rem;border-bottom:1px solid rgba(46,44,40,0.5);vertical-align:middle;}
tr:last-child td{border-bottom:none;}
tr:hover td{background:var(--surface2);}
.badge{display:inline-block;padding:3px 9px;border-radius:999px;font-size:0.7rem;font-weight:700;}
.badge-green{background:rgba(110,201,138,0.15);color:var(--success);}
.badge-yellow{background:rgba(201,185,110,0.15);color:var(--warning);}
.badge-red{background:rgba(201,110,110,0.15);color:var(--danger);}
.badge-blue{background:rgba(110,160,201,0.15);color:var(--info);}
.badge-gray{background:rgba(138,128,112,0.15);color:var(--muted);}
.badge-gold{background:rgba(201,169,110,0.15);color:var(--accent);}
.actions{display:flex;gap:5px;flex-wrap:wrap;}
.modal-overlay{display:none;position:fixed;inset:0;background:rgba(0,0,0,0.75);z-index:999;align-items:center;justify-content:center;backdrop-filter:blur(5px);}
.modal-overlay.open{display:flex;}
.modal{background:var(--surface);border:1px solid var(--border);border-radius:16px;width:600px;max-width:96vw;max-height:92vh;overflow-y:auto;animation:slideUp 0.25s ease;}
@keyframes slideUp{from{opacity:0;transform:translateY(18px);}to{opacity:1;transform:none;}}
.modal-header{padding:20px 24px;border-bottom:1px solid var(--border);display:flex;align-items:center;justify-content:space-between;position:sticky;top:0;background:var(--surface);z-index:1;}
.modal-title{font-family:'Playfair Display',serif;font-size:1.15rem;}
.modal-close{background:none;border:none;color:var(--muted);cursor:pointer;font-size:1.3rem;padding:2px 6px;border-radius:4px;}
.modal-close:hover{color:var(--text);}
.modal-body{padding:22px 24px;}
.modal-footer{padding:14px 24px;border-top:1px solid var(--border);display:flex;justify-content:flex-end;gap:10px;position:sticky;bottom:0;background:var(--surface);}
.form-grid{display:grid;grid-template-columns:1fr 1fr;gap:15px;}
.form-full{grid-column:1/-1;}
.form-hint{font-size:0.72rem;color:var(--muted);margin-top:2px;}
.card{background:var(--surface);border:1px solid var(--border);border-radius:12px;padding:20px;}
.card h3{font-size:0.77rem;font-weight:700;color:var(--muted);text-transform:uppercase;letter-spacing:0.1em;margin-bottom:14px;}
.dash-row{display:grid;grid-template-columns:1fr 1fr;gap:14px;margin-bottom:14px;}
.alert-item{display:flex;align-items:flex-start;gap:10px;padding:10px 0;border-bottom:1px solid var(--border);}
.alert-item:last-child{border-bottom:none;padding-bottom:0;}
.alert-item:first-child{padding-top:0;}
.alert-dot{width:8px;height:8px;border-radius:50%;flex-shrink:0;margin-top:5px;}
.alert-body{flex:1;}
.alert-title{font-size:0.83rem;font-weight:500;}
.alert-sub{font-size:0.73rem;color:var(--muted);margin-top:2px;}
.alert-card{background:var(--surface);border:1px solid var(--border);border-radius:10px;padding:15px 18px;margin-bottom:8px;display:flex;align-items:flex-start;gap:13px;}
.alert-card.red{border-left:3px solid var(--danger);}
.alert-card.yellow{border-left:3px solid var(--warning);}
.alert-card-body{flex:1;}
.alert-card-title{font-size:0.88rem;font-weight:600;margin-bottom:3px;}
.alert-card-sub{font-size:0.76rem;color:var(--muted);}
.alert-card-actions{display:flex;gap:6px;margin-top:8px;flex-wrap:wrap;}
.alerts-section{margin-bottom:22px;}
.alerts-section-title{font-size:0.75rem;font-weight:700;text-transform:uppercase;letter-spacing:0.1em;color:var(--muted);margin-bottom:10px;padding-bottom:8px;border-bottom:1px solid var(--border);}
.arquiler-btn{display:inline-flex;align-items:center;gap:5px;padding:4px 10px;border-radius:6px;background:rgba(201,169,110,0.1);border:1px solid rgba(201,169,110,0.25);color:var(--accent);font-size:0.73rem;font-weight:600;text-decoration:none;}
.empty{text-align:center;padding:48px 20px;color:var(--muted);}
.empty-icon{font-size:2rem;margin-bottom:10px;opacity:0.4;}
.empty p{font-size:0.875rem;}
.toast{position:fixed;bottom:24px;right:24px;background:var(--surface);border:1px solid var(--border);border-radius:10px;padding:13px 18px;font-size:0.85rem;font-weight:500;z-index:9999;animation:toastIn 0.3s ease;box-shadow:0 8px 30px rgba(0,0,0,0.4);}
.toast.success{border-left:3px solid var(--success);color:var(--success);}
.toast.error{border-left:3px solid var(--danger);color:var(--danger);}
@keyframes toastIn{from{opacity:0;transform:translateY(10px);}to{opacity:1;transform:none;}}
.loading-screen{position:fixed;inset:0;background:var(--bg);display:flex;align-items:center;justify-content:center;z-index:9999;flex-direction:column;gap:16px;}
.spinner{width:36px;height:36px;border:2px solid var(--border);border-top-color:var(--accent);border-radius:50%;animation:spin 0.8s linear infinite;}
@keyframes spin{to{transform:rotate(360deg);}}
.owner-header{background:linear-gradient(135deg,rgba(201,169,110,0.1) 0%,transparent 60%);border:1px solid rgba(201,169,110,0.2);border-radius:14px;padding:24px 28px;margin-bottom:22px;}
.owner-header h2{font-family:'Playfair Display',serif;font-size:1.4rem;color:var(--accent);margin-bottom:4px;}
.owner-header p{color:var(--muted);font-size:0.85rem;}
.cfg-box{background:rgba(110,160,201,0.08);border:1px solid rgba(110,160,201,0.25);border-radius:10px;padding:16px 20px;margin-bottom:20px;font-size:0.85rem;color:var(--info);}

/* RECIBO */
.recibo-modal .modal{width:700px;}
.recibo-concepto{display:grid;grid-template-columns:1fr 160px 36px;gap:8px;align-items:center;margin-bottom:8px;}
.recibo-concepto input{margin:0;}
.recibo-total{background:rgba(201,169,110,0.08);border:1px solid rgba(201,169,110,0.25);border-radius:10px;padding:14px 18px;display:flex;justify-content:space-between;align-items:center;margin-top:16px;}
.recibo-total-label{font-size:0.8rem;font-weight:700;text-transform:uppercase;letter-spacing:0.08em;color:var(--muted);}
.recibo-total-val{font-size:1.4rem;font-weight:700;color:var(--accent);}
@media print{
  body > *:not(#printArea){display:none!important;}
  #printArea{display:block!important;position:fixed;inset:0;background:white;padding:40px;z-index:99999;}
  #printArea *{color:#000!important;border-color:#ccc!important;}
}
#printArea{display:none;}
</style>
</head>
<body>

<!-- LOADING -->
<div class="loading-screen" id="loadingScreen">
  <div class="spinner"></div>
  <span style="color:var(--muted);font-size:0.85rem">Cargando...</span>
</div>

<!-- Config ya incluida en el cÃ³digo -->

<!-- LOGIN -->
<div class="login-wrap" id="loginScreen" style="display:none;">
  <div class="login-box">
            <div class="login-logo">
      <h1 style="font-family:'Lato',sans-serif;font-weight:900;font-size:2rem;color:#917860;letter-spacing:0.15em;text-transform:uppercase;margin-bottom:4px;">TerraLex</h1>
      <p style="color:#7a96a8;font-size:0.78rem;letter-spacing:0.1em;text-transform:uppercase;">Estudio JurÃ­dico &amp; Inmobiliario</p>
    </div>
    <div class="login-card">
      <h2>Iniciar sesiÃ³n</h2>
      <div class="login-err" id="loginErr"></div>
      <div class="form-group"><label>Email</label><input type="email" id="login-email" onkeydown="if(event.key==='Enter')doLogin()"></div>
      <div class="form-group" style="margin-bottom:20px;"><label>ContraseÃ±a</label><input type="password" id="login-pass" onkeydown="if(event.key==='Enter')doLogin()"></div>
      <button class="btn btn-primary" id="loginBtn" onclick="doLogin()">Entrar</button>
      <p style="text-align:center;margin-top:14px;font-size:0.78rem;color:var(--muted)">
        Â¿Olvidaste tu contraseÃ±a? <a href="#" onclick="resetPass()" style="color:var(--accent)">Recuperar</a>
      </p>
    </div>
  </div>
</div>

<!-- APP -->
<div class="app" id="app">
  <aside class="sidebar">
    <div class="logo" style="padding:18px 16px;border-bottom:1px solid var(--border);">
  <div style="font-family:'Lato',sans-serif;font-weight:900;font-size:1.1rem;color:var(--accent);letter-spacing:0.15em;text-transform:uppercase;">TerraLex</div>
  <span style="font-size:0.6rem;color:var(--muted);letter-spacing:0.06em;text-transform:uppercase;">GestiÃ³n de Propiedades</span>
</div>
  <span style="font-size:0.58rem;color:var(--muted);letter-spacing:0.06em;text-transform:uppercase;">Estudio JurÃ­dico & Inmobiliario</span>
</div>
  <span style="font-size:0.6rem;color:var(--muted);letter-spacing:0.08em;text-transform:uppercase;">Estudio JurÃ­dico & Inmobiliario</span>
</div>
    <div class="user-pill">
      <div class="user-avatar" id="userAvatar">?</div>
      <div style="flex:1;overflow:hidden;">
        <div class="user-name" id="userName">â€”</div>
        <div class="user-role" id="userRoleLabel">â€”</div>
      </div>
      <button class="logout-btn" onclick="doLogout()" title="Salir">
        <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M9 21H5a2 2 0 01-2-2V5a2 2 0 012-2h4"/><polyline points="16 17 21 12 16 7"/><line x1="21" y1="12" x2="9" y2="12"/></svg>
      </button>
    </div>
    <nav class="nav" id="mainNav"></nav>
  </aside>

  <main class="main">
    <div class="page" id="page-dashboard"><div class="page-header"><div><div class="page-title">Panel Principal</div></div></div><div id="dashContent"></div></div>
    <div class="page" id="page-alertas"><div class="page-header"><div><div class="page-title">Centro de Alertas</div></div></div><div id="alertasContent"></div></div>
    <div class="page" id="page-propiedades">
      <div class="page-header"><div><div class="page-title">Propiedades</div></div><div id="propActions"></div></div>
      <div class="table-wrap"><div class="table-toolbar"><input class="search-input" placeholder="Buscar..." oninput="filterTable('propiedades',this.value)"></div>
      <table><thead><tr id="thead-props"><th>DirecciÃ³n</th><th>Propietario</th><th>Tipo</th><th>mÂ²</th><th>Estado</th><th>Valor</th><th></th></tr></thead><tbody id="tbody-propiedades"></tbody></table></div>
    </div>
    <div class="page" id="page-propietarios">
      <div class="page-header"><div><div class="page-title">Propietarios</div></div><button class="btn btn-primary btn-sm" onclick="openModal('modalPropietario')">+ Agregar</button></div>
      <div class="table-wrap"><table><thead><tr><th>Nombre</th><th>Email</th><th>TelÃ©fono</th><th>Rol</th><th>Estado</th><th></th></tr></thead><tbody id="tbody-propietarios"></tbody></table></div>
    </div>
    <div class="page" id="page-inquilinos">
      <div class="page-header"><div><div class="page-title">Inquilinos</div></div><button class="btn btn-primary btn-sm" onclick="openModal('modalInquilino')">+ Nuevo</button></div>
      <div class="table-wrap"><div class="table-toolbar"><input class="search-input" placeholder="Buscar..." oninput="filterTable('inquilinos',this.value)"></div>
      <table><thead><tr><th>Nombre</th><th>DNI/CUIT</th><th>TelÃ©fono</th><th>Email</th><th>GarantÃ­a</th><th></th></tr></thead><tbody id="tbody-inquilinos"></tbody></table></div>
    </div>
    <div class="page" id="page-contratos">
      <div class="page-header"><div><div class="page-title">Contratos</div></div><div id="contratoActions"></div></div>
      <div class="table-wrap"><div class="table-toolbar"><input class="search-input" placeholder="Buscar..." oninput="filterTable('contratos',this.value)"></div>
      <table><thead><tr><th>Propiedad</th><th>Inquilino</th><th>Inicio</th><th>Vencimiento</th><th>Alquiler</th><th>ActualizaciÃ³n</th><th>Estado</th><th></th></tr></thead><tbody id="tbody-contratos"></tbody></table></div>
    </div>
    <div class="page" id="page-cupones">
      <div class="page-header">
        <div><div class="page-title">Cupones</div><div class="page-sub">EmisiÃ³n mensual de cupones de pago</div></div>
      </div>
      <div class="table-wrap">
        <div class="table-toolbar">
          <input class="search-input" placeholder="Buscar propiedad o inquilino..." oninput="filterCupones(this.value)">
        </div>
        <table>
          <thead><tr>
            <th>Propiedad</th><th>Inquilino</th><th>PerÃ­odo</th>
            <th>Alquiler</th><th>Servicios</th><th>NÂ° CupÃ³n</th>
            <th>Estado</th><th></th>
          </tr></thead>
          <tbody id="tbody-cupones"></tbody>
        </table>
      </div>
    </div>

    <div class="page" id="page-config">
      <div class="page-header"><div><div class="page-title">ConfiguraciÃ³n</div><div class="page-sub">Datos de la empresa que aparecen en los cupones</div></div><button class="btn btn-primary btn-sm" onclick="guardarConfig()">Guardar cambios</button></div>
      <div style="max-width:640px;">
        <div class="card" style="margin-bottom:16px;">
          <h3>ğŸ¢ Datos de la empresa</h3>
          <div class="form-grid">
            <div class="form-group form-full"><label>RazÃ³n Social</label><input id="cfg-razon" placeholder="Ej: Terralex Servicios JurÃ­dicos Inmobiliarios"></div>
            <div class="form-group form-full"><label>Domicilio Comercial</label><input id="cfg-domicilio" placeholder="Ej: TucumÃ¡n 335 - PA"></div>
            <div class="form-group"><label>CUIT</label><input id="cfg-cuit" placeholder="Ej: 20-12345678-9"></div>
            <div class="form-group"><label>CondiciÃ³n frente al IVA</label><select id="cfg-iva"><option>Resp. Monotributista</option><option>Responsable Inscripto</option><option>Exento</option><option>Consumidor Final</option></select></div>
            <div class="form-group"><label>Ingresos Brutos</label><input id="cfg-iibb" placeholder="Ej: Exenta o NÂ° 123456"></div>
            <div class="form-group"><label>Inicio de Actividades</label><input type="date" id="cfg-inicio"></div>
            <div class="form-group"><label>TelÃ©fono</label><input id="cfg-tel" placeholder="Ej: (0351) 123-4567"></div>
            <div class="form-group"><label>Email</label><input type="email" id="cfg-email" placeholder="contacto@empresa.com"></div>
            <div class="form-group form-full"><label>Nota al pie del cupÃ³n</label><input id="cfg-nota" placeholder="Ej: Documento no vÃ¡lido como factura"></div>
          </div>
        </div>
        <div class="card">
          <h3>ğŸ”¢ NumeraciÃ³n de cupones</h3>
          <div class="form-grid">
            <div class="form-group"><label>NÃºmero de contrato base</label><input type="number" id="cfg-contrato-base" placeholder="19"></div>
            <div class="form-group"><label>PrÃ³ximo nÃºmero de cuota</label><input type="number" id="cfg-cuota-next" placeholder="13"></div>
          </div>
          <p class="form-hint" style="margin-top:8px;">Los cupones se numerarÃ¡n como: <strong>NNNN-NNNNNNNNNNNN</strong> (ej: 0019-00000013)</p>
        </div>
      </div>
    </div>

    <div class="page" id="page-pagos">
      <div class="page-header"><div><div class="page-title">Pagos</div></div><div id="pagoActions"></div></div>
      <div class="table-wrap"><div class="table-toolbar"><input class="search-input" placeholder="Buscar..." oninput="filterTable('pagos',this.value)"></div>
      <table><thead><tr><th>Propiedad</th><th>Inquilino</th><th>PerÃ­odo</th><th>Alquiler</th><th>Servicios</th><th>Fecha</th><th>Estado</th><th></th></tr></thead><tbody id="tbody-pagos"></tbody></table></div>
    </div>
  </main>
</div>

<!-- MODALES -->
<div class="modal-overlay" id="modalPropietario">
  <div class="modal">
    <div class="modal-header"><div class="modal-title" id="titlePropietario">Agregar Propietario</div><button class="modal-close" onclick="closeModal('modalPropietario')">âœ•</button></div>
    <div class="modal-body"><div class="form-grid">
      <div class="form-group"><label>Nombre</label><input id="pp-nombre"></div>
      <div class="form-group"><label>Email</label><input type="email" id="pp-email"></div>
      <div class="form-group"><label>TelÃ©fono</label><input id="pp-tel"></div>
      <div class="form-group"><label>ContraseÃ±a inicial</label><input type="password" id="pp-pass"><span class="form-hint">MÃ­nimo 6 caracteres</span></div>
    </div></div>
    <div class="modal-footer"><button class="btn btn-ghost" onclick="closeModal('modalPropietario')">Cancelar</button><button class="btn btn-primary" style="width:auto" onclick="guardarPropietario()">Crear cuenta</button></div>
  </div>
</div>

<div class="modal-overlay" id="modalPropiedad">
  <div class="modal">
    <div class="modal-header"><div class="modal-title" id="titlePropiedad">Nueva Propiedad</div><button class="modal-close" onclick="closeModal('modalPropiedad')">âœ•</button></div>
    <div class="modal-body"><div class="form-grid">
      <div class="form-group form-full"><label>DirecciÃ³n</label><input id="p-dir"></div>
      <div class="form-group"><label>Propietario</label><select id="p-prop"></select></div>
      <div class="form-group"><label>Tipo</label><select id="p-tipo"><option value="">â€”</option><option>Departamento</option><option>Casa</option><option>Local comercial</option><option>Oficina</option><option>Cochera</option><option>DepÃ³sito</option></select></div>
      <div class="form-group"><label>Estado</label><select id="p-est"><option value="Disponible">Disponible</option><option value="Alquilado">Alquilado</option><option value="En reparaciÃ³n">En reparaciÃ³n</option><option value="Reservado">Reservado</option></select></div>
      <div class="form-group"><label>mÂ²</label><input type="number" id="p-m2"></div>
      <div class="form-group"><label>Ambientes</label><input type="number" id="p-amb"></div>
      <div class="form-group"><label>Piso/Unidad</label><input id="p-piso"></div>
      <div class="form-group"><label>Valor ref.</label><input type="number" id="p-val"></div>
      <div class="form-group"><label>Moneda</label><select id="p-mon"><option>ARS</option><option>USD</option></select></div>
      <div class="form-group form-full"><label>Notas</label><textarea id="p-notas"></textarea></div>
    </div></div>
    <div class="modal-footer"><button class="btn btn-ghost" onclick="closeModal('modalPropiedad')">Cancelar</button><button class="btn btn-primary" style="width:auto" onclick="guardarPropiedad()">Guardar</button></div>
  </div>
</div>

<div class="modal-overlay" id="modalInquilino">
  <div class="modal">
    <div class="modal-header"><div class="modal-title" id="titleInquilino">Nuevo Inquilino</div><button class="modal-close" onclick="closeModal('modalInquilino')">âœ•</button></div>
    <div class="modal-body"><div class="form-grid">
      <div class="form-group"><label>Nombre</label><input id="i-nom"></div>
      <div class="form-group"><label>DNI/CUIT</label><input id="i-dni"></div>
      <div class="form-group"><label>TelÃ©fono</label><input id="i-tel"></div>
      <div class="form-group"><label>Email</label><input id="i-email"></div>
      <div class="form-group form-full"><label>Domicilio</label><input id="i-dom"></div>
      <div class="form-group"><label>GarantÃ­a</label><select id="i-gtipo"><option value="">â€”</option><option>Propietario</option><option>Recibo de sueldo</option><option>Seguro de cauciÃ³n</option></select></div>
      <div class="form-group"><label>Datos garantÃ­a</label><input id="i-gdat"></div>
      <div class="form-group form-full"><label>Notas</label><textarea id="i-notas"></textarea></div>
    </div></div>
    <div class="modal-footer"><button class="btn btn-ghost" onclick="closeModal('modalInquilino')">Cancelar</button><button class="btn btn-primary" style="width:auto" onclick="guardarInquilino()">Guardar</button></div>
  </div>
</div>

<div class="modal-overlay" id="modalContrato">
  <div class="modal">
    <div class="modal-header"><div class="modal-title" id="titleContrato">Nuevo Contrato</div><button class="modal-close" onclick="closeModal('modalContrato')">âœ•</button></div>
    <div class="modal-body"><div class="form-grid">
      <div class="form-group"><label>Propiedad</label><select id="c-prop"></select></div>
      <div class="form-group"><label>Inquilino</label><select id="c-inq"></select></div>
      <div class="form-group"><label>Fecha inicio</label><input type="date" id="c-ini"></div>
      <div class="form-group"><label>Fecha vencimiento</label><input type="date" id="c-ven"></div>
      <div class="form-group"><label>Monto mensual</label><input type="number" id="c-monto"></div>
      <div class="form-group"><label>Moneda</label><select id="c-mon"><option>ARS</option><option>USD</option></select></div>
      <div class="form-group"><label>Ãndice</label><select id="c-ind"><option value="IPC">IPC (INDEC)</option><option value="ICL">ICL (BCRA)</option><option value="CER">CER</option><option value="Casa Propia">Casa Propia</option><option value="Acuerdo">Acuerdo partes</option></select></div>
      <div class="form-group"><label>Frecuencia</label><select id="c-frec"><option value="3">Trimestral</option><option value="4">Cuatrimestral</option><option value="6">Semestral</option><option value="12">Anual</option></select></div>
      <div class="form-group"><label>DÃ­a de pago</label><input type="number" id="c-dia" min="1" max="31" placeholder="5"></div>
      <div class="form-group"><label>DÃ­as de gracia</label><input type="number" id="c-grac" min="0" max="15" placeholder="5"></div>
      <div class="form-group"><label>DepÃ³sito</label><input type="number" id="c-dep"></div>
      <div class="form-group"><label>NÂ° Expediente</label><input id="c-exp"></div>
      <div class="form-group form-full"><label>Notas</label><textarea id="c-notas"></textarea></div>
    </div></div>
    <div class="modal-footer"><button class="btn btn-ghost" onclick="closeModal('modalContrato')">Cancelar</button><button class="btn btn-primary" style="width:auto" onclick="guardarContrato()">Guardar</button></div>
  </div>
</div>

<div class="modal-overlay" id="modalPago">
  <div class="modal">
    <div class="modal-header"><div class="modal-title" id="titlePago">Registrar Pago</div><button class="modal-close" onclick="closeModal('modalPago')">âœ•</button></div>
    <div class="modal-body"><div class="form-grid">
      <div class="form-group form-full"><label>Contrato</label><select id="pg-cont" onchange="autoFillPago()"></select></div>
      <div class="form-group"><label>PerÃ­odo</label><input type="month" id="pg-per"></div>
      <div class="form-group"><label>Fecha pago</label><input type="date" id="pg-fecha"></div>
      <div class="form-group"><label>Monto</label><input type="number" id="pg-monto"></div>
      <div class="form-group"><label>Moneda</label><select id="pg-mon"><option>ARS</option><option>USD</option></select></div>
      <div class="form-group"><label>MÃ©todo</label><select id="pg-met"><option>Transferencia</option><option>Efectivo</option><option>Cheque</option><option>DepÃ³sito</option></select></div>
      <div class="form-group"><label>Estado</label><select id="pg-est"><option value="Cobrado">Cobrado</option><option value="Pendiente">Pendiente</option><option value="Atrasado">Atrasado</option></select></div>
      <div class="form-group form-full"><label>Notas</label><textarea id="pg-notas"></textarea></div>
      <div class="form-full" style="border-top:1px solid var(--border);margin-top:8px;padding-top:16px;">
        <div style="font-size:0.75rem;font-weight:700;color:var(--muted);text-transform:uppercase;letter-spacing:0.08em;margin-bottom:12px;">ğŸ’§ Servicios del mes (opcional)</div>
        <div class="form-grid">
          <div class="form-group"><label>Agua</label><input type="number" id="pg-agua" placeholder="0"></div>
          <div class="form-group"><label>Luz</label><input type="number" id="pg-luz" placeholder="0"></div>
          <div class="form-group"><label>Gas</label><input type="number" id="pg-gas" placeholder="0"></div>
          <div class="form-group"><label>ContribuciÃ³n municipal</label><input type="number" id="pg-municipal" placeholder="0"></div>
          <div class="form-group"><label>Rentas provincial</label><input type="number" id="pg-rentas" placeholder="0"></div>
          <div class="form-group"><label>Otros</label><input type="number" id="pg-otros" placeholder="0"><span class="form-hint"><input type="text" id="pg-otros-label" placeholder="DescripciÃ³n (ej: ABSA)" style="margin-top:4px;font-size:0.78rem;padding:6px 10px;"></span></div>
        </div>
      </div>
    </div></div>
    <div class="modal-footer"><button class="btn btn-ghost" onclick="closeModal('modalPago')">Cancelar</button><button class="btn btn-primary" style="width:auto" onclick="guardarPago()">Registrar</button></div>
  </div>
</div>

<!-- MODAL EMITIR CUPÃ“N -->
<div class="modal-overlay" id="modalCupon">
  <div class="modal">
    <div class="modal-header">
      <div class="modal-title" id="titleCupon">Emitir CupÃ³n</div>
      <button class="modal-close" onclick="closeModal('modalCupon')">âœ•</button>
    </div>
    <div class="modal-body">
      <div id="cupon-info" style="background:var(--surface2);border-radius:10px;padding:14px 16px;margin-bottom:20px;font-size:0.85rem;line-height:1.9;"></div>
      <div class="form-grid">
        <div class="form-group">
          <label>PerÃ­odo</label>
          <input type="month" id="cupon-periodo">
        </div>
        <div class="form-group">
          <label>Monto alquiler</label>
          <input type="number" id="cupon-monto" placeholder="0">
        </div>
      </div>
      <div style="border-top:1px solid var(--border);margin-top:12px;padding-top:14px;">
        <div style="font-size:0.75rem;font-weight:700;color:var(--muted);text-transform:uppercase;letter-spacing:0.08em;margin-bottom:12px;">ğŸ’§ Servicios (opcional)</div>
        <div class="form-grid">
          <div class="form-group"><label>Agua</label><input type="number" id="cupon-agua" placeholder="0"></div>
          <div class="form-group"><label>Luz</label><input type="number" id="cupon-luz" placeholder="0"></div>
          <div class="form-group"><label>Gas</label><input type="number" id="cupon-gas" placeholder="0"></div>
          <div class="form-group"><label>ContribuciÃ³n municipal</label><input type="number" id="cupon-municipal" placeholder="0"></div>
          <div class="form-group"><label>Rentas provincial</label><input type="number" id="cupon-rentas" placeholder="0"></div>
          <div class="form-group"><label>Otros</label>
            <input type="number" id="cupon-otros" placeholder="0">
            <input type="text" id="cupon-otros-label" placeholder="DescripciÃ³n (ej: ABSA)" style="margin-top:4px;font-size:0.78rem;padding:6px 10px;">
          </div>
        </div>
      </div>
    </div>
    <div class="modal-footer">
      <button class="btn btn-ghost" onclick="closeModal('modalCupon')">Cancelar</button>
      <button class="btn btn-primary" style="width:auto;" onclick="emitirCupon()">ğŸ“„ Emitir cupÃ³n</button>
    </div>
  </div>
</div>

<!-- MODAL RECIBO -->
<div class="modal-overlay recibo-modal" id="modalRecibo">
  <div class="modal">
    <div class="modal-header">
      <div class="modal-title">ğŸ“„ Generar Recibo</div>
      <button class="modal-close" onclick="closeModal('modalRecibo')">âœ•</button>
    </div>
    <div class="modal-body">
      <div id="recibo-info" style="background:var(--surface2);border-radius:10px;padding:14px 16px;margin-bottom:20px;font-size:0.85rem;line-height:1.8;"></div>
      <div style="font-size:0.75rem;font-weight:700;color:var(--muted);text-transform:uppercase;letter-spacing:0.08em;margin-bottom:10px;">Conceptos del recibo</div>
      <div style="display:grid;grid-template-columns:1fr 160px 36px;gap:8px;margin-bottom:6px;">
        <span style="font-size:0.7rem;color:var(--muted);font-weight:600;text-transform:uppercase;">DescripciÃ³n</span>
        <span style="font-size:0.7rem;color:var(--muted);font-weight:600;text-transform:uppercase;">Monto (ARS)</span>
        <span></span>
      </div>
      <div id="recibo-conceptos"></div>
      <button class="btn btn-ghost btn-sm" style="margin-top:8px;" onclick="agregarConcepto()">+ Agregar concepto</button>
      <div class="recibo-total">
        <span class="recibo-total-label">Total a pagar</span>
        <span class="recibo-total-val" id="recibo-total-val">$ 0</span>
      </div>
    </div>
    <div class="modal-footer">
      <button class="btn btn-ghost" onclick="closeModal('modalRecibo')">Cancelar</button>
      <button class="btn btn-primary" style="width:auto;" onclick="imprimirRecibo()">ğŸ–¨ï¸ Imprimir / Guardar PDF</button>
    </div>
  </div>
</div>

<!-- ÃREA DE IMPRESIÃ“N -->
<div id="printArea"></div>

<script type="module">
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// FIREBASE IMPORTS (ESM â€” sin CDN externo)
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
import { initializeApp } from 'https://www.gstatic.com/firebasejs/10.12.0/firebase-app.js';
import { getAuth, signInWithEmailAndPassword, signOut, createUserWithEmailAndPassword, sendPasswordResetEmail, onAuthStateChanged } from 'https://www.gstatic.com/firebasejs/10.12.0/firebase-auth.js';
import { getFirestore, collection, doc, getDoc, getDocs, setDoc, addDoc, updateDoc, deleteDoc, query, where, orderBy } from 'https://www.gstatic.com/firebasejs/10.12.0/firebase-firestore.js';

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// CONFIG
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function getConfig(){ try{ return JSON.parse(localStorage.getItem('gp_cfg')||'null'); }catch(e){ return null; } }

window.saveConfig = function(){
  const apiKey   = document.getElementById('cfg-apiKey').value.trim();
  const authDomain = document.getElementById('cfg-authDomain').value.trim();
  const projectId  = document.getElementById('cfg-projectId').value.trim();
  const databaseURL = document.getElementById('cfg-dbUrl').value.trim();
  if(!apiKey||!authDomain||!projectId){ showToast('CompletÃ¡ API Key, Auth Domain y Project ID','error'); return; }
  localStorage.setItem('gp_cfg', JSON.stringify({apiKey,authDomain,projectId,databaseURL}));
  location.reload();
};

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// SECURITY HELPERS
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function esc(str){
  if(!str && str !== 0) return 'â€”';
  return String(str)
    .replace(/&/g,'&amp;')
    .replace(/</g,'&lt;')
    .replace(/>/g,'&gt;')
    .replace(/"/g,'&quot;')
    .replace(/'/g,'&#x27;');
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// STATE
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
let auth, db;
let currentUser = null;
let currentProfile = null;
let cache = { propiedades:[], propietarios:[], inquilinos:[], contratos:[], pagos:[], cupones:[] };
let editMode = { type:null, id:null };

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// INIT
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// Config hardcodeada â€” no necesita pantalla de configuraciÃ³n
const cfg = {
  apiKey: "AIzaSyCBnPwiCNadRFIONaxLe0VpfoU3NCQIbbA",
  authDomain: "gestorprop-f00fc.firebaseapp.com",
  projectId: "gestorprop-f00fc"
};
{
  const app = initializeApp(cfg);
  auth = getAuth(app);
  db   = getFirestore(app);

  onAuthStateChanged(auth, async (user) => {
    // Siempre ocultar el panel hasta confirmar auth
    document.getElementById('app').classList.remove('visible');
    if(user){
      currentUser = user;
      try {
        const snap = await getDoc(doc(db,'Users',user.uid));
        currentProfile = snap.exists() ? snap.data() : { uid:user.uid, email:user.email, nombre:user.email, rol:'propietario' };
        // Solo mostrar la app DESPUÃ‰S de confirmar identidad en Firebase
        await loadAllData();
        document.getElementById('loadingScreen').style.display='none';
        document.getElementById('loginScreen').style.display='none';
        document.getElementById('app').classList.add('visible');
        setupUI();
        showPage('dashboard');
      } catch(e){
        console.error(e);
        await signOut(auth); // forzar logout si falla la carga
        document.getElementById('loadingScreen').style.display='none';
        showLogin();
        showToast('Error al cargar datos: '+e.message,'error');
      }
    } else {
      document.getElementById('loadingScreen').style.display='none';
      showLogin();
    }
  });
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// AUTH
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function showLogin(){
  document.getElementById('loginScreen').style.display='flex';
  document.getElementById('app').classList.remove('visible');
}

window.doLogin = async function(){
  const email = document.getElementById('login-email').value.trim();
  const pass  = document.getElementById('login-pass').value;
  const btn   = document.getElementById('loginBtn');
  const err   = document.getElementById('loginErr');
  err.classList.remove('show');
  btn.textContent='Ingresando...'; btn.disabled=true;
  try {
    await signInWithEmailAndPassword(auth, email, pass);
    // onAuthStateChanged se encarga del resto
  } catch(e){
    const msgs = {'auth/invalid-credential':'Email o contraseÃ±a incorrectos.','auth/user-not-found':'Email o contraseÃ±a incorrectos.','auth/wrong-password':'Email o contraseÃ±a incorrectos.','auth/too-many-requests':'Demasiados intentos. EsperÃ¡ unos minutos.'};
    err.textContent = msgs[e.code] || e.message;
    err.classList.add('show');
    btn.textContent='Entrar'; btn.disabled=false;
  }
};

window.doLogout = async function(){
  await signOut(auth);
  currentUser=null; currentProfile=null;
  cache={ propiedades:[], propietarios:[], inquilinos:[], contratos:[], pagos:[], cupones:[] };
};

window.resetPass = async function(){
  const email = prompt('IngresÃ¡ tu email:');
  if(!email) return;
  await sendPasswordResetEmail(auth, email);
  showToast('Se enviÃ³ un email de recuperaciÃ³n','success');
};

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// DATA
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function isAdmin(){ return currentProfile?.rol === 'admin'; }

async function loadAllData(){
  const loads = [
    getDocs(collection(db,'Users')),
    getDocs(collection(db,'propiedades')),
    getDocs(collection(db,'contratos')),
    getDocs(collection(db,'pagos')),
  ];
  if(isAdmin()) loads.push(getDocs(collection(db,'inquilinos')));
  if(isAdmin()) loads.push(getDocs(collection(db,'cupones')));

  const [usuSnap, propSnap, contSnap, pagSnap, inqSnap, cupSnap] = await Promise.all(loads);

  cache.propietarios = usuSnap.docs.map(d=>({id:d.id,...d.data()}));
  cache.propiedades  = propSnap.docs.map(d=>({id:d.id,...d.data()}));
  cache.contratos    = contSnap.docs.map(d=>({id:d.id,...d.data()}));
  cache.pagos        = pagSnap.docs.map(d=>({id:d.id,...d.data()}));
  cache.inquilinos   = inqSnap ? inqSnap.docs.map(d=>({id:d.id,...d.data()})) : [];
  cache.cupones      = cupSnap ? cupSnap.docs.map(d=>({id:d.id,...d.data()})) : [];

  // Si no es admin, filtrar solo sus propiedades
  if(!isAdmin()){
    cache.propiedades = cache.propiedades.filter(p=>p.propietario_id===currentUser.uid);
    const myPropIds = new Set(cache.propiedades.map(p=>p.id));
    cache.contratos  = cache.contratos.filter(c=>myPropIds.has(c.propiedad_id));
    const myContIds  = new Set(cache.contratos.map(c=>c.id));
    cache.pagos      = cache.pagos.filter(p=>myContIds.has(p.contrato_id));
  }
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// UI
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function setupUI(){
  const p = currentProfile;
  document.getElementById('userName').textContent = p?.nombre || p?.email || 'â€”';
  document.getElementById('userRoleLabel').textContent = isAdmin() ? 'ğŸ‘‘ Administrador' : 'ğŸ  Propietario';
  document.getElementById('userAvatar').textContent = (p?.nombre||'?')[0].toUpperCase();

  const adminItems = isAdmin() ? `
    <div class="nav-label">GestiÃ³n</div>
    <div class="nav-item" data-page="cupones" onclick="showPage('cupones',this)">
      <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><rect x="2" y="5" width="20" height="14" rx="2"/><line x1="2" y1="10" x2="22" y2="10"/><line x1="6" y1="15" x2="10" y2="15"/></svg>Cupones
    </div>
    <div class="nav-item" data-page="propietarios" onclick="showPage('propietarios',this)">
      <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M17 21v-2a4 4 0 00-4-4H5a4 4 0 00-4 4v2"/><circle cx="9" cy="7" r="4"/></svg>Propietarios
    </div>
    <div class="nav-item" data-page="inquilinos" onclick="showPage('inquilinos',this)">
      <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="12" cy="7" r="4"/><path d="M20 21a8 8 0 10-16 0"/></svg>Inquilinos
    </div>` : '';

  document.getElementById('mainNav').innerHTML = `
    <div class="nav-item active" data-page="dashboard" onclick="showPage('dashboard',this)">
      <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><rect x="3" y="3" width="7" height="7"/><rect x="14" y="3" width="7" height="7"/><rect x="14" y="14" width="7" height="7"/><rect x="3" y="14" width="7" height="7"/></svg>Panel
    </div>
    <div class="nav-item" data-page="alertas" onclick="showPage('alertas',this)">
      <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M18 8A6 6 0 006 8c0 7-3 9-3 9h18s-3-2-3-9"/><path d="M13.73 21a2 2 0 01-3.46 0"/></svg>Alertas
      <span class="nav-badge" id="nav-badge" style="display:none">0</span>
    </div>
    ${adminItems}
    <div class="nav-item" data-page="propiedades" onclick="showPage('propiedades',this)">
      <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M3 9l9-7 9 7v11a2 2 0 01-2 2H5a2 2 0 01-2-2z"/><polyline points="9 22 9 12 15 12 15 22"/></svg>Propiedades
    </div>
    <div class="nav-item" data-page="contratos" onclick="showPage('contratos',this)">
      <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M14 2H6a2 2 0 00-2 2v16a2 2 0 002 2h12a2 2 0 002-2V8z"/><polyline points="14 2 14 8 20 8"/></svg>Contratos
    </div>
    <div class="nav-item" data-page="pagos" onclick="showPage('pagos',this)">
      <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><rect x="1" y="4" width="22" height="16" rx="2"/><line x1="1" y1="10" x2="23" y2="10"/></svg>Pagos
    </div>
    ${isAdmin()?`<div class="nav-label">Sistema</div>
    <div class="nav-item" data-page="config" onclick="showPage('config',this)">
      <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="12" cy="12" r="3"/><path d="M19.4 15a1.65 1.65 0 00.33 1.82l.06.06a2 2 0 010 2.83 2 2 0 01-2.83 0l-.06-.06a1.65 1.65 0 00-1.82-.33 1.65 1.65 0 00-1 1.51V21a2 2 0 01-2 2 2 2 0 01-2-2v-.09A1.65 1.65 0 009 19.4a1.65 1.65 0 00-1.82.33l-.06.06a2 2 0 01-2.83 0 2 2 0 010-2.83l.06-.06A1.65 1.65 0 004.68 15a1.65 1.65 0 00-1.51-1H3a2 2 0 01-2-2 2 2 0 012-2h.09A1.65 1.65 0 004.6 9a1.65 1.65 0 00-.33-1.82l-.06-.06a2 2 0 010-2.83 2 2 0 012.83 0l.06.06A1.65 1.65 0 009 4.68a1.65 1.65 0 001-1.51V3a2 2 0 012-2 2 2 0 012 2v.09a1.65 1.65 0 001 1.51 1.65 1.65 0 001.82-.33l.06-.06a2 2 0 012.83 0 2 2 0 010 2.83l-.06.06A1.65 1.65 0 0019.4 9a1.65 1.65 0 001.51 1H21a2 2 0 012 2 2 2 0 01-2 2h-.09a1.65 1.65 0 00-1.51 1z"/></svg>ConfiguraciÃ³n
    </div>`:''}`;

  document.getElementById('propActions').innerHTML    = isAdmin() ? `<button class="btn btn-primary btn-sm" onclick="openModalPropiedad()">+ Nueva propiedad</button>` : '';
  document.getElementById('contratoActions').innerHTML = isAdmin() ? `<button class="btn btn-primary btn-sm" onclick="openContratoModal()">+ Nuevo contrato</button>` : '';
  document.getElementById('pagoActions').innerHTML    = isAdmin() ? `<button class="btn btn-primary btn-sm" onclick="openModalPago()">+ Registrar pago</button>` : '';

  if(!isAdmin()){
    document.getElementById('thead-props').innerHTML = '<th>DirecciÃ³n</th><th>Tipo</th><th>mÂ²</th><th>Estado</th><th>Valor</th><th></th>';
  }
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// NAVIGATION
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// â”€â”€ SESSION TIMEOUT (2 horas de inactividad) â”€â”€
let _inactivityTimer;
function resetInactivityTimer(){
  clearTimeout(_inactivityTimer);
  _inactivityTimer = setTimeout(async()=>{
    await signOut(auth);
    showToast('SesiÃ³n cerrada por inactividad','error');
  }, 2 * 60 * 60 * 1000); // 2 horas
}
['click','keydown','mousemove','touchstart'].forEach(e=>document.addEventListener(e, resetInactivityTimer, {passive:true}));

window.showPage = function(name, el){
  document.querySelectorAll('.page').forEach(p=>p.classList.remove('active'));
  document.querySelectorAll('.nav-item').forEach(n=>n.classList.remove('active'));
  document.getElementById('page-'+name).classList.add('active');
  (el || document.querySelector(`[data-page="${name}"]`))?.classList.add('active');
  ({dashboard:renderDashboard,alertas:renderAlertas,propiedades:renderPropiedades,propietarios:renderPropietarios,inquilinos:renderInquilinos,contratos:renderContratos,pagos:renderPagos,cupones:renderCupones,config:renderConfigPage})[name]?.();
};

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// HELPERS
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function fmtDate(d){ if(!d) return 'â€”'; const s=typeof d==='string'?d:d?.toDate?.().toISOString()||''; const[y,m,day]=s.split('T')[0].split('-'); return `${day}/${m}/${y}`; }
function fmtMoney(n,cur){ if(!n&&n!==0) return 'â€”'; return (cur==='USD'?'U$D ':'$ ')+Number(n).toLocaleString('es-AR'); }
function diasHasta(d){ if(!d) return 9999; const s=typeof d==='string'?d:d?.toDate?.().toISOString()||''; return Math.round((new Date(s.split('T')[0]+'T00:00:00')-new Date())/86400000); }
function getProp(id){ return cache.propiedades.find(x=>x.id===id); }
function getInq(id){ return cache.inquilinos.find(x=>x.id===id); }
function getCont(id){ return cache.contratos.find(x=>x.id===id); }
function getPropietario(id){ return cache.propietarios.find(x=>x.id===id); }
function arquilerLink(c){ if(!c?.fecha_inicio||!c?.monto) return 'https://arquiler.com/'; const im={IPC:'IPC',ICL:'ICL',CER:'CER','Casa Propia':'CasaPropia',Acuerdo:'IPC'}; const fi=typeof c.fecha_inicio==='string'?c.fecha_inicio:c.fecha_inicio?.toDate?.().toISOString().split('T')[0]; return `https://arquiler.com/?monto=${c.monto}&inicio=${fi}&meses=${c.actualizacion_meses||3}&indice=${im[c.indice]||'IPC'}`; }

window.showToast = function(msg,type='success'){
  const t=document.createElement('div'); t.className=`toast ${type}`; t.textContent=msg;
  document.body.appendChild(t); setTimeout(()=>t.remove(),3500);
};

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// MODAL
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
window.openModal = function(id){ document.getElementById(id).classList.add('open'); };
window.closeModal = function(id){
  document.getElementById(id).classList.remove('open'); editMode={type:null,id:null};
  document.querySelectorAll(`#${id} input,#${id} select,#${id} textarea`).forEach(el=>{ if(el.tagName==='SELECT') el.selectedIndex=0; else el.value=''; });
};
document.querySelectorAll('.modal-overlay').forEach(m=>m.addEventListener('click',function(e){ if(e.target===this) window.closeModal(this.id); }));

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// PROPIETARIOS
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
window.guardarPropietario = async function(){
  const nombre=document.getElementById('pp-nombre').value.trim();
  const email=document.getElementById('pp-email').value.trim();
  const tel=document.getElementById('pp-tel').value.trim();
  const pass=document.getElementById('pp-pass').value;
  if(!nombre||!email||!pass){ showToast('CompletÃ¡ todos los campos','error'); return; }
  if(pass.length < 8){ showToast('La contraseÃ±a debe tener al menos 8 caracteres','error'); return; }
  if(!/[A-Z]/.test(pass)){ showToast('La contraseÃ±a debe tener al menos una mayÃºscula','error'); return; }
  if(!/[0-9]/.test(pass)){ showToast('La contraseÃ±a debe tener al menos un nÃºmero','error'); return; }
  try {
    // Usar REST API para crear usuario SIN cambiar la sesiÃ³n del admin
    const apiKey = cfg.apiKey;
    const res = await fetch(`https://identitytoolkit.googleapis.com/v1/accounts:signUp?key=${apiKey}`, {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ email, password: pass, returnSecureToken: true })
    });
    const data = await res.json();
    if(!res.ok) throw new Error(data.error?.message || 'Error al crear usuario');
    const uid = data.localId;
    // Guardar perfil en Firestore (la sesiÃ³n del admin no cambiÃ³)
    await setDoc(doc(db,'Users',uid),{nombre,email,telefono:tel,rol:'propietario',activo:true,created_at:new Date().toISOString()});
    showToast('Propietario creado. Ya puede iniciar sesiÃ³n.','success');
    closeModal('modalPropietario');
    await loadAllData(); renderPropietarios();
  } catch(e){ 
    const msgs = {'EMAIL_EXISTS':'Ese email ya estÃ¡ registrado.','WEAK_PASSWORD : Password should be at least 6 characters':'La contraseÃ±a debe tener al menos 6 caracteres.'};
    showToast(msgs[e.message] || e.message,'error'); 
  }
};

function renderPropietarios(){
  const tbody=document.getElementById('tbody-propietarios');
  if(!cache.propietarios.length){ tbody.innerHTML=`<tr><td colspan="6"><div class="empty"><div class="empty-icon">ğŸ‘¤</div><p>No hay propietarios</p></div></td></tr>`; return; }
  tbody.innerHTML=cache.propietarios.map(p=>`<tr>
    <td><strong>${esc(p.nombre)}</strong></td><td>${esc(p.email)}</td><td>${esc(p.telefono)||'â€”'}</td>
    <td><span class="badge ${p.rol==='admin'?'badge-gold':'badge-blue'}">${p.rol==='admin'?'Admin':'Propietario'}</span></td>
    <td><span class="badge ${p.activo?'badge-green':'badge-gray'}">${p.activo?'Activo':'Inactivo'}</span></td>
    <td><button class="btn btn-${p.activo?'danger':'ghost'} btn-xs" onclick="togglePropietario('${p.id}',${p.activo})">${p.activo?'Desactivar':'Activar'}</button></td>
  </tr>`).join('');
}
window.togglePropietario = async function(id,activo){
  if(!confirm(`Â¿${activo?'Desactivar':'Activar'}?`)) return;
  await updateDoc(doc(db,'Users',id),{activo:!activo});
  await loadAllData(); renderPropietarios();
  showToast(`${activo?'Desactivado':'Activado'}`,'success');
};

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// PROPIEDADES
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
window.openModalPropiedad = function(){
  document.getElementById('p-prop').innerHTML='<option value="">Seleccionar...</option>'+
    cache.propietarios.filter(p=>p.rol==='propietario').map(p=>`<option value="${p.id}">${p.nombre}</option>`).join('');
  openModal('modalPropiedad');
};
window.guardarPropiedad = async function(){
  const o={direccion:document.getElementById('p-dir').value.trim(),propietario_id:document.getElementById('p-prop').value,tipo:document.getElementById('p-tipo').value,estado:document.getElementById('p-est').value,m2:document.getElementById('p-m2').value||null,ambientes:document.getElementById('p-amb').value||null,piso:document.getElementById('p-piso').value,valor:document.getElementById('p-val').value||null,moneda:document.getElementById('p-mon').value,notas:document.getElementById('p-notas').value};
  if(!o.direccion||!o.propietario_id){ showToast('DirecciÃ³n y propietario obligatorios','error'); return; }
  try {
    if(editMode.id) await updateDoc(doc(db,'propiedades',editMode.id),o);
    else await addDoc(collection(db,'propiedades'),{...o,created_at:new Date().toISOString()});
    showToast('Propiedad guardada','success'); closeModal('modalPropiedad');
    await loadAllData(); renderPropiedades();
  } catch(e){ showToast(e.message,'error'); }
};
function renderPropiedades(filter=''){
  const tbody=document.getElementById('tbody-propiedades');
  let rows=cache.propiedades; if(filter) rows=rows.filter(p=>p.direccion?.toLowerCase().includes(filter));
  if(!rows.length){ tbody.innerHTML=`<tr><td colspan="7"><div class="empty"><div class="empty-icon">ğŸ </div><p>No hay propiedades</p></div></td></tr>`; return; }
  const eb={Disponible:'badge-green',Alquilado:'badge-blue','En reparaciÃ³n':'badge-yellow',Reservado:'badge-yellow'};
  tbody.innerHTML=rows.map(p=>{
    const owner=getPropietario(p.propietario_id);
    const acts=isAdmin()?`<button class="btn btn-ghost btn-xs" onclick="editPropiedad('${p.id}')">Editar</button><button class="btn btn-danger btn-xs" onclick="delPropiedad('${p.id}')">âœ•</button>`:'';
    return `<tr><td><strong>${esc(p.direccion)}</strong>${p.piso?`<br><small style="color:var(--muted)">${esc(p.piso)}</small>`:''}</td>${isAdmin()?`<td>${esc(owner?.nombre)||'â€”'}</td>`:''}<td>${esc(p.tipo)||'â€”'}</td><td>${p.m2?p.m2+' mÂ²':'â€”'}</td><td><span class="badge ${eb[p.estado]||'badge-gray'}">${esc(p.estado)}</span></td><td>${fmtMoney(p.valor,p.moneda)}</td><td><div class="actions">${acts}</div></td></tr>`;
  }).join('');
}
window.editPropiedad = function(id){ const p=getProp(id); if(!p) return; editMode={type:'propiedades',id}; openModalPropiedad(); setTimeout(()=>{ document.getElementById('p-dir').value=p.direccion||''; document.getElementById('p-prop').value=p.propietario_id||''; document.getElementById('p-tipo').value=p.tipo||''; document.getElementById('p-est').value=p.estado||''; document.getElementById('p-m2').value=p.m2||''; document.getElementById('p-amb').value=p.ambientes||''; document.getElementById('p-piso').value=p.piso||''; document.getElementById('p-val').value=p.valor||''; document.getElementById('p-mon').value=p.moneda||'ARS'; document.getElementById('p-notas').value=p.notas||''; document.getElementById('titlePropiedad').textContent='Editar Propiedad'; },50); };
window.delPropiedad = async function(id){ if(!confirm('Â¿Eliminar?')) return; await deleteDoc(doc(db,'propiedades',id)); await loadAllData(); renderPropiedades(); showToast('Eliminada'); };

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// INQUILINOS
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
window.guardarInquilino = async function(){
  const o={nombre:document.getElementById('i-nom').value.trim(),dni:document.getElementById('i-dni').value.trim(),telefono:document.getElementById('i-tel').value.trim(),email:document.getElementById('i-email').value.trim(),domicilio:document.getElementById('i-dom').value.trim(),garantia_tipo:document.getElementById('i-gtipo').value,garantia_datos:document.getElementById('i-gdat').value.trim(),notas:document.getElementById('i-notas').value,admin_id:currentUser.uid};
  if(!o.nombre){ showToast('Nombre obligatorio','error'); return; }
  try {
    if(editMode.id) await updateDoc(doc(db,'inquilinos',editMode.id),o);
    else await addDoc(collection(db,'inquilinos'),{...o,created_at:new Date().toISOString()});
    showToast('Guardado','success'); closeModal('modalInquilino'); await loadAllData(); renderInquilinos();
  } catch(e){ showToast(e.message,'error'); }
};
function renderInquilinos(filter=''){
  const tbody=document.getElementById('tbody-inquilinos');
  let rows=cache.inquilinos; if(filter) rows=rows.filter(i=>(i.nombre||'').toLowerCase().includes(filter)||(i.dni||'').includes(filter));
  if(!rows.length){ tbody.innerHTML=`<tr><td colspan="6"><div class="empty"><div class="empty-icon">ğŸ‘¤</div><p>No hay inquilinos</p></div></td></tr>`; return; }
  tbody.innerHTML=rows.map(i=>`<tr><td><strong>${esc(i.nombre)}</strong></td><td>${esc(i.dni)||'â€”'}</td><td>${esc(i.telefono)||'â€”'}</td><td>${esc(i.email)||'â€”'}</td><td>${i.garantia_tipo?`<span class="badge badge-blue">${esc(i.garantia_tipo)}</span>`:'â€”'}</td><td><div class="actions"><button class="btn btn-ghost btn-xs" onclick="editInquilino('${i.id}')">Editar</button><button class="btn btn-danger btn-xs" onclick="delInquilino('${i.id}')">âœ•</button></div></td></tr>`).join('');
}
window.editInquilino = function(id){ const i=getInq(id); if(!i) return; editMode={type:'inquilinos',id}; document.getElementById('i-nom').value=i.nombre||''; document.getElementById('i-dni').value=i.dni||''; document.getElementById('i-tel').value=i.telefono||''; document.getElementById('i-email').value=i.email||''; document.getElementById('i-dom').value=i.domicilio||''; document.getElementById('i-gtipo').value=i.garantia_tipo||''; document.getElementById('i-gdat').value=i.garantia_datos||''; document.getElementById('i-notas').value=i.notas||''; document.getElementById('titleInquilino').textContent='Editar Inquilino'; openModal('modalInquilino'); };
window.delInquilino = async function(id){ if(!confirm('Â¿Eliminar?')) return; await deleteDoc(doc(db,'inquilinos',id)); await loadAllData(); renderInquilinos(); showToast('Eliminado'); };

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// CONTRATOS
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
window.openContratoModal = function(){
  document.getElementById('c-prop').innerHTML='<option value="">Seleccionar...</option>'+cache.propiedades.map(p=>`<option value="${p.id}">${esc(p.direccion)}</option>`).join('');
  document.getElementById('c-inq').innerHTML='<option value="">Seleccionar...</option>'+cache.inquilinos.map(i=>`<option value="${i.id}">${esc(i.nombre)}</option>`).join('');
  openModal('modalContrato');
};
window.guardarContrato = async function(){
  const o={propiedad_id:document.getElementById('c-prop').value,inquilino_id:document.getElementById('c-inq').value||null,fecha_inicio:document.getElementById('c-ini').value||null,fecha_vencimiento:document.getElementById('c-ven').value||null,monto:document.getElementById('c-monto').value||null,moneda:document.getElementById('c-mon').value,indice:document.getElementById('c-ind').value,actualizacion_meses:parseInt(document.getElementById('c-frec').value),dia_pago:document.getElementById('c-dia').value||null,dias_gracia:document.getElementById('c-grac').value||5,deposito:document.getElementById('c-dep').value||null,expediente:document.getElementById('c-exp').value,notas:document.getElementById('c-notas').value};
  if(!o.propiedad_id){ showToast('SeleccionÃ¡ una propiedad','error'); return; }
  try {
    if(editMode.id) await updateDoc(doc(db,'contratos',editMode.id),o);
    else { await addDoc(collection(db,'contratos'),{...o,created_at:new Date().toISOString()}); await updateDoc(doc(db,'propiedades',o.propiedad_id),{estado:'Alquilado'}); }
    showToast('Contrato guardado','success'); closeModal('modalContrato'); await loadAllData(); renderContratos();
  } catch(e){ showToast(e.message,'error'); }
};
function contratoEst(c){ if(!c.fecha_vencimiento) return {l:'Activo',cls:'badge-green'}; const d=diasHasta(c.fecha_vencimiento); if(d<0) return {l:'Vencido',cls:'badge-red'}; if(d<=60) return {l:`${d}d`,cls:'badge-yellow'}; return {l:'Activo',cls:'badge-green'}; }
function renderContratos(filter=''){
  const tbody=document.getElementById('tbody-contratos');
  let rows=cache.contratos; if(filter) rows=rows.filter(c=>{ const p=getProp(c.propiedad_id); const i=getInq(c.inquilino_id); return (p&&p.direccion?.toLowerCase().includes(filter))||(i&&i.nombre?.toLowerCase().includes(filter)); });
  if(!rows.length){ tbody.innerHTML=`<tr><td colspan="8"><div class="empty"><div class="empty-icon">ğŸ“„</div><p>No hay contratos</p></div></td></tr>`; return; }
  const fl={3:'Trimestral',4:'Cuatrimestral',6:'Semestral',12:'Anual'};
  tbody.innerHTML=rows.map(c=>{ const p=getProp(c.propiedad_id); const i=getInq(c.inquilino_id); const e=contratoEst(c); const acts=isAdmin()?`<button class="btn btn-ghost btn-xs" onclick="editContrato('${c.id}')">Editar</button><button class="btn btn-danger btn-xs" onclick="delContrato('${c.id}')">âœ•</button>`:''; return `<tr><td>${esc(p?.direccion)||'â€”'}</td><td>${esc(i?.nombre)||'â€”'}</td><td>${fmtDate(c.fecha_inicio)}</td><td>${fmtDate(c.fecha_vencimiento)}</td><td><strong>${fmtMoney(c.monto,c.moneda)}</strong></td><td style="font-size:.76rem">${fl[c.actualizacion_meses]||c.actualizacion_meses+'m'} / ${esc(c.indice)}</td><td><span class="badge ${e.cls}">${e.l}</span></td><td><div class="actions"><a href="${arquilerLink(c)}" target="_blank" class="arquiler-btn">ğŸ”—</a>${acts}</div></td></tr>`; }).join('');
}
window.editContrato = function(id){ const c=getCont(id); if(!c) return; editMode={type:'contratos',id}; openContratoModal(); setTimeout(()=>{ document.getElementById('c-prop').value=c.propiedad_id||''; document.getElementById('c-inq').value=c.inquilino_id||''; document.getElementById('c-ini').value=c.fecha_inicio||''; document.getElementById('c-ven').value=c.fecha_vencimiento||''; document.getElementById('c-monto').value=c.monto||''; document.getElementById('c-mon').value=c.moneda||'ARS'; document.getElementById('c-ind').value=c.indice||'IPC'; document.getElementById('c-frec').value=c.actualizacion_meses||3; document.getElementById('c-dia').value=c.dia_pago||''; document.getElementById('c-grac').value=c.dias_gracia||5; document.getElementById('c-dep').value=c.deposito||''; document.getElementById('c-exp').value=c.expediente||''; document.getElementById('c-notas').value=c.notas||''; document.getElementById('titleContrato').textContent='Editar Contrato'; },50); };
window.delContrato = async function(id){ if(!confirm('Â¿Eliminar?')) return; await deleteDoc(doc(db,'contratos',id)); await loadAllData(); renderContratos(); showToast('Eliminado'); };

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// PAGOS
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
window.openModalPago = async function(contratoId){
  // Recargar contratos frescos antes de abrir el modal
  if(cache.contratos.length === 0){
    try {
      const snap = await getDocs(collection(db,'contratos'));
      cache.contratos = snap.docs.map(d=>({id:d.id,...d.data()}));
    } catch(e){}
  }
  const opts = cache.contratos.map(c=>{
    const p=getProp(c.propiedad_id); const i=getInq(c.inquilino_id);
    const label = (p?.direccion||'Sin direcciÃ³n') + (i?' â€” '+i.nombre:'');
    return `<option value="${c.id}">${label}</option>`;
  }).join('');
  document.getElementById('pg-cont').innerHTML='<option value="">Seleccionar contrato...</option>'+opts;
  const hoy=new Date(); document.getElementById('pg-fecha').value=hoy.toISOString().split('T')[0]; document.getElementById('pg-per').value=hoy.toISOString().slice(0,7);
  if(contratoId){ document.getElementById('pg-cont').value=contratoId; autoFillPago(); }
  openModal('modalPago');
};
window.autoFillPago = function(){ const c=getCont(document.getElementById('pg-cont').value); if(c){ document.getElementById('pg-monto').value=c.monto||''; document.getElementById('pg-mon').value=c.moneda||'ARS'; } };
window.guardarPago = async function(){
  const o={
    contrato_id:document.getElementById('pg-cont').value,
    periodo:document.getElementById('pg-per').value,
    fecha_pago:document.getElementById('pg-fecha').value||null,
    monto:document.getElementById('pg-monto').value||null,
    moneda:document.getElementById('pg-mon').value,
    metodo:document.getElementById('pg-met').value,
    estado:document.getElementById('pg-est').value,
    notas:document.getElementById('pg-notas').value,
    servicios:{
      agua:   parseFloat(document.getElementById('pg-agua').value)||0,
      luz:    parseFloat(document.getElementById('pg-luz').value)||0,
      gas:    parseFloat(document.getElementById('pg-gas').value)||0,
      municipal: parseFloat(document.getElementById('pg-municipal').value)||0,
      rentas: parseFloat(document.getElementById('pg-rentas').value)||0,
      otros:  parseFloat(document.getElementById('pg-otros').value)||0,
      otros_label: document.getElementById('pg-otros-label').value||''
    }
  };
  if(!o.contrato_id){ showToast('SeleccionÃ¡ un contrato','error'); return; }
  try {
    if(editMode.id) await updateDoc(doc(db,'pagos',editMode.id),o);
    else await addDoc(collection(db,'pagos'),{...o,created_at:new Date().toISOString()});
    // Marcar cupÃ³n como pagado si existe
    if(!editMode.id){
      const cuponExist = cache.cupones.find(cu => cu.contrato_id === o.contrato_id && cu.periodo === o.periodo);
      if(cuponExist){
        await updateDoc(doc(db,'cupones',cuponExist.id),{ pagado:true, fecha_pago: o.fecha_pago || new Date().toISOString().split('T')[0] });
      }
    }
    showToast('Pago registrado','success'); closeModal('modalPago'); await loadAllData(); renderPagos(); updateAlertBadge();
  } catch(e){ showToast(e.message,'error'); }
};
function totalServicios(sv){ if(!sv) return 0; return (sv.agua||0)+(sv.luz||0)+(sv.gas||0)+(sv.municipal||0)+(sv.rentas||0)+(sv.otros||0); }
function renderPagos(filter=''){
  const tbody=document.getElementById('tbody-pagos');
  let rows=cache.pagos; if(filter) rows=rows.filter(pg=>{ const c=getCont(pg.contrato_id); const p=c?getProp(c.propiedad_id):null; const i=c?getInq(c.inquilino_id):null; return (p&&p.direccion?.toLowerCase().includes(filter))||(i&&i.nombre?.toLowerCase().includes(filter)); });
  if(!rows.length){ tbody.innerHTML=`<tr><td colspan="8"><div class="empty"><div class="empty-icon">ğŸ’³</div><p>No hay pagos</p></div></td></tr>`; return; }
  const eb={Cobrado:'badge-green',Pendiente:'badge-yellow',Atrasado:'badge-red'};
  tbody.innerHTML=rows.map(pg=>{ const c=getCont(pg.contrato_id); const p=c?getProp(c.propiedad_id):null; const i=c?getInq(c.inquilino_id):null; const per=pg.periodo?pg.periodo.split('-').reverse().join('/'):'â€”'; const ts=totalServicios(pg.servicios); const acts=isAdmin()?`<button class="btn btn-ghost btn-xs" onclick="generarRecibo('${pg.id}')">ğŸ§¾ Recibo</button><button class="btn btn-ghost btn-xs" onclick="editPago('${pg.id}')">Editar</button><button class="btn btn-danger btn-xs" onclick="delPago('${pg.id}')">âœ•</button>`:`<button class="btn btn-ghost btn-xs" onclick="generarRecibo('${pg.id}')">ğŸ§¾ Recibo</button>`; return `<tr><td>${esc(p?.direccion)||'â€”'}</td><td>${esc(i?.nombre)||'â€”'}</td><td>${per}</td><td><strong>${fmtMoney(pg.monto,pg.moneda)}</strong></td><td>${ts>0?fmtMoney(ts,pg.moneda):'â€”'}</td><td>${fmtDate(pg.fecha_pago)}</td><td><span class="badge ${eb[pg.estado]||'badge-gray'}">${esc(pg.estado)}</span></td><td><div class="actions">${acts}</div></td></tr>`; }).join('');
}
window.editPago = function(id){ const pg=cache.pagos.find(x=>x.id===id); if(!pg) return; editMode={type:'pagos',id}; openModalPago(pg.contrato_id); setTimeout(()=>{ document.getElementById('pg-cont').value=pg.contrato_id||''; document.getElementById('pg-per').value=pg.periodo||''; document.getElementById('pg-fecha').value=pg.fecha_pago||''; document.getElementById('pg-monto').value=pg.monto||''; document.getElementById('pg-mon').value=pg.moneda||'ARS'; document.getElementById('pg-met').value=pg.metodo||''; document.getElementById('pg-est').value=pg.estado||'Cobrado'; document.getElementById('pg-notas').value=pg.notas||''; const sv=pg.servicios||{}; document.getElementById('pg-agua').value=sv.agua||''; document.getElementById('pg-luz').value=sv.luz||''; document.getElementById('pg-gas').value=sv.gas||''; document.getElementById('pg-municipal').value=sv.municipal||''; document.getElementById('pg-rentas').value=sv.rentas||''; document.getElementById('pg-otros').value=sv.otros||''; document.getElementById('pg-otros-label').value=sv.otros_label||''; document.getElementById('titlePago').textContent='Editar Pago'; },50); };
window.delPago = async function(id){ if(!confirm('Â¿Eliminar?')) return; await deleteDoc(doc(db,'pagos',id)); await loadAllData(); renderPagos(); showToast('Eliminado'); };

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// ALERTAS
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function calcAlertas(){
  const hoy=new Date(); const mes=hoy.getMonth()+1; const anio=hoy.getFullYear(); const dia=hoy.getDate();
  const alertas=[];
  cache.contratos.forEach(c=>{
    const p=getProp(c.propiedad_id); const i=getInq(c.inquilino_id);
    if(c.fecha_vencimiento){ const d=diasHasta(c.fecha_vencimiento); if(d<0) alertas.push({tipo:'contrato-vencido',urgencia:'red',dias:d,c,p,i}); else if(d<=60) alertas.push({tipo:'contrato-vencer',urgencia:d<=30?'red':'yellow',dias:d,c,p,i}); }
    if(c.fecha_inicio&&c.actualizacion_meses){
      const fi=typeof c.fecha_inicio==='string'?c.fecha_inicio:c.fecha_inicio?.toDate?.().toISOString().split('T')[0];
      const ini=new Date(fi+'T00:00:00'); const mt=(anio-ini.getFullYear())*12+(mes-(ini.getMonth()+1));
      if(mt>=c.actualizacion_meses){ const ciclos=Math.floor(mt/c.actualizacion_meses); const pma=ini.getMonth()+1+ciclos*c.actualizacion_meses; const pa=ini.getFullYear()+Math.floor((ini.getMonth()+pma-1)/12); const pm=((pma-1)%12)+1; const pf=`${pa}-${String(pm).padStart(2,'0')}-${String(ini.getDate()).padStart(2,'0')}`; const d=diasHasta(pf); if(d>=-15&&d<=30) alertas.push({tipo:'actualizacion',urgencia:d<0?'red':'yellow',dias:d,c,p,i,proxFecha:pf}); }
    }
    if(c.dia_pago){
      const dp=parseInt(c.dia_pago); const gr=parseInt(c.dias_gracia)||5; const per=`${anio}-${String(mes).padStart(2,'0')}`;
      const pagado=cache.pagos.some(pg=>pg.contrato_id===c.id&&pg.periodo===per&&pg.estado==='Cobrado');
      if(!pagado){ const dh=dp-dia; if(dia>dp+gr) alertas.push({tipo:'pago-atrasado',urgencia:'red',dias:dh,diaPago:dp,per,c,p,i}); else if(dh>=0&&dh<=5) alertas.push({tipo:'pago-proximo',urgencia:'yellow',dias:dh,diaPago:dp,per,c,p,i}); }
    }
  });
  return alertas;
}
function updateAlertBadge(){ const n=calcAlertas().length; const b=document.getElementById('nav-badge'); if(!b) return; if(n>0){b.textContent=n;b.style.display='';}else b.style.display='none'; }
function renderAlertas(){
  const alertas=calcAlertas(); const el=document.getElementById('alertasContent');
  if(!alertas.length){ el.innerHTML=`<div class="card" style="text-align:center;padding:60px"><div style="font-size:3rem;margin-bottom:14px">âœ…</div><strong>Todo en orden</strong><p style="color:var(--muted);margin-top:6px">Sin alertas pendientes.</p></div>`; return; }
  const sec=(items,title,icon,cls)=>{ if(!items.length) return ''; return `<div class="alerts-section"><div class="alerts-section-title">${icon} ${title} (${items.length})</div>`+items.map(a=>{ const pN=a.p?.direccion||'?'; const iN=a.i?.nombre||'?'; let tit='',sub='',act=''; if(a.tipo==='contrato-vencido'){tit=`Contrato VENCIDO â€” ${pN}`;sub=`Inquilino: ${iN} Â· VenciÃ³ el ${fmtDate(a.c.fecha_vencimiento)}`;} else if(a.tipo==='contrato-vencer'){tit=`Contrato por vencer â€” ${pN}`;sub=`Inquilino: ${iN} Â· Vence en ${a.dias} dÃ­as`;} else if(a.tipo==='actualizacion'){const fl={3:'Trimestral',4:'Cuatrimestral',6:'Semestral',12:'Anual'};tit=`ActualizaciÃ³n ${fl[a.c.actualizacion_meses]||''} â€” ${pN}`;sub=`${iN} Â· ${fmtMoney(a.c.monto,a.c.moneda)}`;act=`<a href="${arquilerLink(a.c)}" target="_blank" class="arquiler-btn">ğŸ”— ARquiler.com</a>`;} else if(a.tipo==='pago-atrasado'){tit=`Pago ATRASADO â€” ${pN}`;sub=`${iN} Â· VencÃ­a el dÃ­a ${a.diaPago}`;if(isAdmin())act=`<button class="btn btn-primary btn-xs" onclick="openModalPago('${a.c.id}')">Registrar</button>`;} else if(a.tipo==='pago-proximo'){tit=`Pago prÃ³ximo â€” ${pN}`;sub=`${iN} Â· Vence el dÃ­a ${a.diaPago} (en ${a.dias} dÃ­as)`;if(isAdmin())act=`<button class="btn btn-ghost btn-xs" onclick="openModalPago('${a.c.id}')">Registrar</button>`;} return `<div class="alert-card ${cls}"><div style="font-size:1.1rem">ğŸ””</div><div class="alert-card-body"><div class="alert-card-title">${tit}</div><div class="alert-card-sub">${sub}</div><div class="alert-card-actions">${act}</div></div></div>`; }).join('')+'</div>'; };
  el.innerHTML=sec(alertas.filter(a=>a.tipo==='pago-atrasado'),'Pagos Atrasados','ğŸš¨','red')+sec(alertas.filter(a=>a.tipo==='contrato-vencido'),'Contratos Vencidos','ğŸ“›','red')+sec(alertas.filter(a=>a.tipo==='actualizacion'),'Actualizaciones','ğŸ“Š','yellow')+sec(alertas.filter(a=>a.tipo==='pago-proximo'),'Pagos PrÃ³ximos','â°','yellow')+sec(alertas.filter(a=>a.tipo==='contrato-vencer'),'Contratos por Vencer','ğŸ“‹','yellow');
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// DASHBOARD
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function renderDashboard(){
  const alertas=calcAlertas(); const urgentes=alertas.filter(a=>a.urgencia==='red'); updateAlertBadge();
  const props=cache.propiedades; const conts=cache.contratos; const pags=cache.pagos;
  const alq=props.filter(p=>p.estado==='Alquilado').length;
  const activos=conts.filter(c=>!c.fecha_vencimiento||diasHasta(c.fecha_vencimiento)>=0).length;
  const mes=new Date().toISOString().slice(0,7);
  const cobrado=pags.filter(p=>p.estado==='Cobrado'&&p.periodo===mes).reduce((s,p)=>s+Number(p.monto||0),0);
  const banner=!isAdmin()?`<div class="owner-header"><h2>Bienvenido, ${currentProfile?.nombre||'Propietario'}</h2><p>Estado de tus propiedades, contratos y pagos.</p></div>`:'';
  document.getElementById('dashContent').innerHTML=`${banner}
    <div class="stats-grid">
      <div class="stat-card accent"><div class="stat-label">Propiedades</div><div class="stat-val">${props.length}</div><div class="stat-sub">${alq} alquiladas</div></div>
      <div class="stat-card"><div class="stat-label">Contratos activos</div><div class="stat-val">${activos}</div><div class="stat-sub">${conts.length} total</div></div>
      <div class="stat-card ${urgentes.length?'danger':''}"><div class="stat-label">Alertas</div><div class="stat-val">${alertas.length}</div><div class="stat-sub">${urgentes.length} urgentes</div></div>
      <div class="stat-card success"><div class="stat-label">Cobrado este mes</div><div class="stat-val" style="font-size:1.2rem">$${cobrado.toLocaleString('es-AR')}</div><div class="stat-sub">ARS</div></div>
    </div>
    <div class="dash-row">
      <div class="card"><h3>ğŸ”” Alertas urgentes</h3><div id="d-urg"></div></div>
      <div class="card"><h3>ğŸ’° Ãšltimos pagos</h3><div id="d-pag"></div></div>
    </div>
    <div class="dash-row">
      <div class="card"><h3>ğŸ  Propiedades</h3><div id="d-props"></div></div>
      <div class="card"><h3>ğŸ“‹ Contratos por vencer</h3><div id="d-vencs"></div></div>
    </div>`;
  const du=document.getElementById('d-urg'); if(!urgentes.length) du.innerHTML=`<div class="empty"><div class="empty-icon">âœ…</div><p>Sin urgencias</p></div>`; else du.innerHTML=urgentes.slice(0,4).map(a=>`<div class="alert-item"><div class="alert-dot" style="background:var(--danger)"></div><div class="alert-body"><div class="alert-title">${esc(a.p?.direccion)||'â€”'}</div><div class="alert-sub">${esc(a.i?.nombre)||''} Â· ${a.tipo.replace(/-/g,' ')}</div></div></div>`).join('');
  const dp=document.getElementById('d-pag'); if(!pags.length) dp.innerHTML=`<div class="empty"><div class="empty-icon">â€”</div><p>Sin pagos</p></div>`; else dp.innerHTML=pags.slice(0,5).map(pg=>{ const c=getCont(pg.contrato_id); const i=c?getInq(c.inquilino_id):null; const col=pg.estado==='Cobrado'?'var(--success)':pg.estado==='Atrasado'?'var(--danger)':'var(--warning)'; return `<div class="alert-item"><div class="alert-dot" style="background:${col}"></div><div class="alert-body"><div class="alert-title">${esc(i?.nombre)||'â€”'} â€” ${fmtMoney(pg.monto,pg.moneda)}</div><div class="alert-sub">${fmtDate(pg.fecha_pago)} Â· <span style="color:${col}">${esc(pg.estado)}</span></div></div></div>`; }).join('');
  const dpr=document.getElementById('d-props'); if(!props.length) dpr.innerHTML=`<div class="empty"><div class="empty-icon">ğŸ </div><p>Sin propiedades</p></div>`; else dpr.innerHTML=props.slice(0,5).map(p=>{ const eb={Disponible:'badge-green',Alquilado:'badge-blue','En reparaciÃ³n':'badge-yellow'}; return `<div class="alert-item"><div class="alert-dot" style="background:var(--accent)"></div><div class="alert-body"><div class="alert-title">${esc(p.direccion)}</div><div class="alert-sub"><span class="badge ${eb[p.estado]||'badge-gray'}" style="font-size:.65rem">${esc(p.estado)}</span> ${p.tipo?'Â· '+esc(p.tipo):''}</div></div></div>`; }).join('');
  const dv=document.getElementById('d-vencs'); const pv=conts.filter(c=>c.fecha_vencimiento&&diasHasta(c.fecha_vencimiento)>=0&&diasHasta(c.fecha_vencimiento)<=90).sort((a,b)=>diasHasta(a.fecha_vencimiento)-diasHasta(b.fecha_vencimiento)); if(!pv.length) dv.innerHTML=`<div class="empty"><div class="empty-icon">âœ“</div><p>Sin vencimientos prÃ³ximos</p></div>`; else dv.innerHTML=pv.slice(0,5).map(c=>{ const p=getProp(c.propiedad_id); const i=getInq(c.inquilino_id); const d=diasHasta(c.fecha_vencimiento); const col=d<=30?'var(--danger)':'var(--warning)'; return `<div class="alert-item"><div class="alert-dot" style="background:${col}"></div><div class="alert-body"><div class="alert-title">${esc(p?.direccion)||'â€”'}</div><div class="alert-sub">${i?.nombre||''} Â· <strong style="color:${col}">${d} dÃ­as</strong></div></div></div>`; }).join('');
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// CUPONES
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
let _cuponContratoId = null;

window.abrirModalCupon = function(contratoId){
  _cuponContratoId = contratoId;
  const c = cache.contratos.find(x=>x.id===contratoId);
  const p = c ? getProp(c.propiedad_id) : null;
  const i = c ? getInq(c.inquilino_id)  : null;
  document.getElementById('cupon-info').innerHTML =
    `<strong>Propiedad:</strong> ${esc(p?.direccion)||'â€”'}<br>
     <strong>Inquilino:</strong> ${esc(i?.nombre)||'â€”'}<br>
     <strong>Alquiler base:</strong> ${fmtMoney(c?.monto, c?.moneda)}`;
  // PerÃ­odo = mes actual
  document.getElementById('cupon-periodo').value = new Date().toISOString().slice(0,7);
  document.getElementById('cupon-monto').value = c?.monto || '';
  // Limpiar servicios
  ['cupon-agua','cupon-luz','cupon-gas','cupon-municipal','cupon-rentas','cupon-otros'].forEach(id=>{
    document.getElementById(id).value='';
  });
  document.getElementById('cupon-otros-label').value='';
  document.getElementById('titleCupon').textContent = `Emitir CupÃ³n â€” ${p?.direccion||''}`;
  openModal('modalCupon');
};

window.emitirCupon = async function(){
  if(!_cuponContratoId){ showToast('Error: sin contrato','error'); return; }
  if(!_empresaConfig) await loadEmpresaConfig();
  const emp = _empresaConfig || {};

  const periodo = document.getElementById('cupon-periodo').value;
  if(!periodo){ showToast('SeleccionÃ¡ el perÃ­odo','error'); return; }

  // Verificar si ya existe cupÃ³n para ese contrato+perÃ­odo
  const existe = cache.cupones.find(cu=>cu.contrato_id===_cuponContratoId && cu.periodo===periodo);
  if(existe){ showToast('Ya existe un cupÃ³n para ese perÃ­odo','error'); return; }

  // NÃºmero de cupÃ³n
  const nContrato = String(emp.contrato_base||1).padStart(4,'0');
  const nCuota    = String(emp.cuota_next||1).padStart(12,'0');
  const numero    = `${nContrato}-${nCuota}`;

  const servicios = {
    agua:      parseFloat(document.getElementById('cupon-agua').value)||0,
    luz:       parseFloat(document.getElementById('cupon-luz').value)||0,
    gas:       parseFloat(document.getElementById('cupon-gas').value)||0,
    municipal: parseFloat(document.getElementById('cupon-municipal').value)||0,
    rentas:    parseFloat(document.getElementById('cupon-rentas').value)||0,
    otros:     parseFloat(document.getElementById('cupon-otros').value)||0,
    otros_label: document.getElementById('cupon-otros-label').value||''
  };

  const cuponData = {
    contrato_id: _cuponContratoId,
    periodo,
    monto:    parseFloat(document.getElementById('cupon-monto').value)||0,
    moneda:   (cache.contratos.find(x=>x.id===_cuponContratoId)?.moneda)||'ARS',
    servicios,
    numero,
    pagado:   false,
    created_at: new Date().toISOString()
  };

  try {
    const ref = await addDoc(collection(db,'cupones'), cuponData);
    // Incrementar cuota_next
    if(emp.cuota_next){
      const next = (parseInt(emp.cuota_next)||1)+1;
      await updateDoc(doc(db,'config','empresa'),{cuota_next:next});
      if(_empresaConfig) _empresaConfig.cuota_next = next;
    }
    cache.cupones.push({id:ref.id,...cuponData});
    showToast('CupÃ³n emitido','success');
    closeModal('modalCupon');
    // Abrir PDF en nueva pestaÃ±a
    abrirPdfCupon({id:ref.id,...cuponData});
    renderCupones();
  } catch(e){ showToast(e.message,'error'); }
};

window.abrirPdfCupon = function(cupon){
  const c   = getCont(cupon.contrato_id);
  const p   = c ? getProp(c.propiedad_id) : null;
  const i   = c ? getInq(c.inquilino_id)  : null;
  const emp = _empresaConfig || {};
  const sv  = cupon.servicios || {};
  const moneda = cupon.moneda==='USD'?'U$D ':'$ ';
  const fmt = n => (n&&Number(n)>0) ? moneda+Number(n).toLocaleString('es-AR') : null;
  const hoy = new Date().toLocaleDateString('es-AR');
  const meses=['Enero','Febrero','Marzo','Abril','Mayo','Junio','Julio','Agosto','Septiembre','Octubre','Noviembre','Diciembre'];
  let periodoLabel = cupon.periodo;
  if(cupon.periodo){ const[ay,am]=cupon.periodo.split('-'); periodoLabel=`${meses[parseInt(am)-1]} ${ay}`; }
  let fechaVto = 'â€”';
  if(c?.dia_pago && cupon.periodo){ const[ay,am]=cupon.periodo.split('-'); fechaVto=`${String(c.dia_pago).padStart(2,'0')}/${am}/${ay}`; }

  const totalSv = (sv.agua||0)+(sv.luz||0)+(sv.gas||0)+(sv.municipal||0)+(sv.rentas||0)+(sv.otros||0);
  const totalGeneral = (cupon.monto||0) + totalSv;

  const svFilas = [
    {l:'Agua',val:sv.agua},{l:'Luz',val:sv.luz},{l:'Gas',val:sv.gas},
    {l:'ContribuciÃ³n Municipal',val:sv.municipal},{l:'Rentas Provincial',val:sv.rentas},
    {l:sv.otros_label||'Otros',val:sv.otros}
  ].filter(x=>x.val>0).map(x=>`
    <div class="fila"><span>${x.l}</span><span>${fmt(x.val)}</span></div>`).join('');

  const html = `<!DOCTYPE html><html lang="es"><head><meta charset="UTF-8">
<title>CupÃ³n ${cupon.numero}</title>
<style>
*{box-sizing:border-box;margin:0;padding:0;}
body{font-family:'Helvetica Neue',Arial,sans-serif;background:#eee;padding:30px 20px;display:flex;justify-content:center;}
.cupon{background:white;width:640px;border:1px solid #bbb;box-shadow:0 2px 16px rgba(0,0,0,.15);}
.invalido{text-align:center;padding:5px;font-size:0.68rem;color:#888;font-style:italic;border-bottom:1px solid #ddd;background:#f9f9f9;}
.header{display:grid;grid-template-columns:1fr auto;gap:16px;padding:20px 24px;border-bottom:2px solid #111;}
.emp-nombre{font-size:1rem;font-weight:700;margin-bottom:4px;}
.emp-dato{font-size:0.76rem;color:#444;margin-bottom:2px;}
.num-lado{text-align:right;border-left:1px solid #ddd;padding-left:16px;}
.num-tipo{font-size:0.65rem;font-weight:700;text-transform:uppercase;letter-spacing:.1em;color:#888;margin-bottom:4px;}
.num-val{font-size:1rem;font-weight:700;font-family:monospace;color:#111;}
.num-fecha{font-size:0.74rem;color:#666;margin-top:4px;}
.body{padding:20px 24px;}
.datos{display:grid;grid-template-columns:1fr 1fr;gap:8px;background:#f8f8f8;border-radius:6px;padding:12px;margin-bottom:16px;}
.dato label{font-size:0.65rem;text-transform:uppercase;letter-spacing:.07em;color:#999;display:block;margin-bottom:2px;}
.dato span{font-size:0.84rem;font-weight:500;color:#111;}
.tabla-header{display:flex;justify-content:space-between;font-size:0.67rem;font-weight:700;text-transform:uppercase;letter-spacing:.08em;color:#888;padding:7px 12px;background:#f0f0f0;border-radius:4px 4px 0 0;}
.fila{display:flex;justify-content:space-between;padding:9px 12px;border-bottom:1px solid #f0f0f0;font-size:0.84rem;}
.fila:nth-child(odd){background:#fafafa;}
.fila.principal{font-weight:600;background:#fffbf4;}
.fila.total{background:#111;color:white;font-weight:700;font-size:0.92rem;border-radius:0 0 4px 4px;}
.fila.total span:last-child{color:#917860;}
.nota{background:#fffbf0;border-left:3px solid #917860;padding:10px 14px;font-size:0.78rem;color:#555;margin-top:14px;line-height:1.6;}
.pie{background:#f5f5f5;border-top:1px solid #ddd;padding:12px 24px;display:flex;justify-content:space-between;align-items:center;}
.pie p{font-size:0.7rem;color:#999;}
@media print{body{background:white;padding:0;}.cupon{box-shadow:none;border:none;width:100%;}.no-print{display:none!important;}}
</style></head><body>
<div class="cupon">
  <div class="invalido">${emp.nota||'Documento no vÃ¡lido como comprobante de pago'}</div>
  <div class="header">
    <div>
      <div class="emp-nombre">${emp.razon||'TerraLex'}</div>
      ${emp.domicilio?`<div class="emp-dato">ğŸ“ ${emp.domicilio}</div>`:''}
      ${emp.cuit?`<div class="emp-dato">CUIT: ${emp.cuit}</div>`:''}
      ${emp.iva?`<div class="emp-dato">Cond. IVA: ${emp.iva}</div>`:''}
      ${emp.iibb?`<div class="emp-dato">Ing. Brutos: ${emp.iibb}</div>`:''}
      ${emp.inicio?`<div class="emp-dato">Inicio act.: ${new Date(emp.inicio+'T12:00:00').toLocaleDateString('es-AR')}</div>`:''}
    </div>
    <div class="num-lado">
      <div class="num-tipo">CupÃ³n de Pago</div>
      <div class="num-val">${cupon.numero}</div>
      <div class="num-fecha">EmisiÃ³n: ${hoy}</div>
      <div class="num-fecha">Vencimiento: ${fechaVto}</div>
    </div>
  </div>
  <div class="body">
    <div class="datos">
      <div class="dato"><label>Inquilino</label><span>${i?.nombre||'â€”'}</span></div>
      <div class="dato"><label>DNI / CUIT</label><span>${i?.dni||'â€”'}</span></div>
      <div class="dato"><label>Propiedad</label><span>${p?.direccion||'â€”'}${p?.piso?' Â· '+p.piso:''}</span></div>
      <div class="dato"><label>PerÃ­odo</label><span>${periodoLabel}</span></div>
      ${c?.expediente?`<div class="dato"><label>NÂ° Expediente</label><span>${c.expediente}</span></div>`:''}
      <div class="dato"><label>Propietario</label><span>${getPropietario(p?.propietario_id)?.nombre||'â€”'}</span></div>
    </div>
    <div class="tabla-header"><span>Concepto</span><span>Importe</span></div>
    <div class="fila principal"><span>Alquiler â€” ${periodoLabel}</span><span>${fmt(cupon.monto)||'â€”'}</span></div>
    ${svFilas}
    <div class="fila total"><span>IMPORTE TOTAL</span><span>${moneda}${totalGeneral.toLocaleString('es-AR')}</span></div>
  </div>
  <div class="pie">
    <p>Generado el ${hoy}${emp.tel?' Â· '+emp.tel:''}${emp.email?' Â· '+emp.email:''}</p>
    <button onclick="window.print()" class="no-print" style="background:#111;color:#917860;border:none;padding:9px 18px;border-radius:6px;font-weight:700;cursor:pointer;font-size:0.82rem;">ğŸ–¨ï¸ Imprimir / PDF</button>
  </div>
</div>
</body></html>`;

  const win = window.open('','_blank');
  win.document.write(html);
  win.document.close();
};

function renderCupones(filter=''){
  const tbody = document.getElementById('tbody-cupones');
  // Mostrar contratos activos con su estado de cupÃ³n
  let contratos = cache.contratos.filter(c=>{
    if(c.fecha_vencimiento && diasHasta(c.fecha_vencimiento)<0) return false;
    return true;
  });
  if(filter){
    contratos = contratos.filter(c=>{
      const p=getProp(c.propiedad_id); const i=getInq(c.inquilino_id);
      return (p&&p.direccion?.toLowerCase().includes(filter))||(i&&i.nombre?.toLowerCase().includes(filter));
    });
  }
  if(!contratos.length){
    tbody.innerHTML=`<tr><td colspan="8"><div class="empty"><div class="empty-icon">ğŸ“„</div><p>No hay contratos activos</p></div></td></tr>`;
    return;
  }
  const mesPer = new Date().toISOString().slice(0,7);
  tbody.innerHTML = contratos.map(c=>{
    const p  = getProp(c.propiedad_id);
    const i  = getInq(c.inquilino_id);
    const cupon = cache.cupones.find(cu=>cu.contrato_id===c.id && cu.periodo===mesPer);
    let estadoBadge, acciones;
    if(!cupon){
      estadoBadge = `<span class="badge badge-gray">No emitido</span>`;
      acciones = `<button class="btn btn-primary btn-xs" onclick="abrirModalCupon('${c.id}')">Emitir</button>`;
    } else if(cupon.pagado){
      estadoBadge = `<span class="badge badge-green">Pagado</span>`;
      acciones = `<button class="btn btn-ghost btn-xs" onclick="abrirPdfCupon(${JSON.stringify(cupon).replace(/"/g,'&quot;')})">ğŸ“„ Ver</button>`;
    } else {
      estadoBadge = `<span class="badge badge-yellow">Emitido</span>`;
      acciones = `<button class="btn btn-ghost btn-xs" onclick="abrirPdfCupon(${JSON.stringify(cupon).replace(/"/g,'&quot;')})">ğŸ“„ Ver</button>
                  <button class="btn btn-danger btn-xs" onclick="anularCupon('${cupon.id}')">Anular</button>`;
    }
    const svTotal = cupon ? totalServicios(cupon.servicios) : 0;
    return `<tr>
      <td><strong>${esc(p?.direccion)||'â€”'}</strong></td>
      <td>${esc(i?.nombre)||'â€”'}</td>
      <td>${mesPer.split('-').reverse().join('/')}</td>
      <td>${fmtMoney(c.monto, c.moneda)}</td>
      <td>${svTotal>0?fmtMoney(svTotal,c.moneda):'â€”'}</td>
      <td style="font-family:monospace;font-size:0.8rem;">${cupon?.numero||'â€”'}</td>
      <td>${estadoBadge}</td>
      <td><div class="actions">${acciones}</div></td>
    </tr>`;
  }).join('');
}

window.anularCupon = async function(id){
  if(!confirm('Â¿Anular este cupÃ³n?')) return;
  try {
    await deleteDoc(doc(db,'cupones',id));
    cache.cupones = cache.cupones.filter(c=>c.id!==id);
    showToast('CupÃ³n anulado');
    renderCupones();
  } catch(e){ showToast(e.message,'error'); }
};

window.filterCupones = function(val){ renderCupones(val.toLowerCase().trim()); };

window.filterTable = function(type,val){ const f=val.toLowerCase().trim(); ({propiedades:renderPropiedades,inquilinos:renderInquilinos,contratos:renderContratos,pagos:renderPagos})[type]?.(f); };

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// RECIBO
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// RECIBO Y CONFIGURACIÃ“N
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// â”€â”€ CONFIG PAGE â”€â”€
let _empresaConfig = null;

async function loadEmpresaConfig(){
  try {
    const snap = await getDoc(doc(db,'config','empresa'));
    _empresaConfig = snap.exists() ? snap.data() : {};
  } catch(e){ _empresaConfig = {}; }
}

window.renderConfigPage = async function(){
  await loadEmpresaConfig();
  const c = _empresaConfig || {};
  const setValue = (id, val) => { const el = document.getElementById(id); if(el && val) el.value = val; };
  setValue('cfg-razon', c.razon);
  setValue('cfg-domicilio', c.domicilio);
  setValue('cfg-cuit', c.cuit);
  if(c.iva) document.getElementById('cfg-iva').value = c.iva;
  setValue('cfg-iibb', c.iibb);
  setValue('cfg-inicio', c.inicio);
  setValue('cfg-tel', c.tel);
  setValue('cfg-email', c.email);
  setValue('cfg-nota', c.nota);
  setValue('cfg-contrato-base', c.contrato_base);
  setValue('cfg-cuota-next', c.cuota_next);
};

window.guardarConfig = async function(){
  const cfg = {
    razon:          document.getElementById('cfg-razon').value.trim(),
    domicilio:      document.getElementById('cfg-domicilio').value.trim(),
    cuit:           document.getElementById('cfg-cuit').value.trim(),
    iva:            document.getElementById('cfg-iva').value,
    iibb:           document.getElementById('cfg-iibb').value.trim(),
    inicio:         document.getElementById('cfg-inicio').value,
    tel:            document.getElementById('cfg-tel').value.trim(),
    email:          document.getElementById('cfg-email').value.trim(),
    nota:           document.getElementById('cfg-nota').value.trim(),
    contrato_base:  parseInt(document.getElementById('cfg-contrato-base').value) || 1,
    cuota_next:     parseInt(document.getElementById('cfg-cuota-next').value) || 1,
    updated_at:     new Date().toISOString(),
  };
  try {
    await setDoc(doc(db,'config','empresa'), cfg);
    _empresaConfig = cfg;
    showToast('ConfiguraciÃ³n guardada','success');
  } catch(e){ showToast(e.message,'error'); }
};

window.generarRecibo = async function(pagoId){
  // Cargar config si no estÃ¡ en memoria
  if(!_empresaConfig) await loadEmpresaConfig();
  const emp = _empresaConfig || {};

  const pg = cache.pagos.find(x=>x.id===pagoId); if(!pg) return;
  const c  = getCont(pg.contrato_id);
  const p  = c ? getProp(c.propiedad_id) : null;
  const i  = c ? getInq(c.inquilino_id)  : null;
  const sv = pg.servicios || {};
  const moneda = pg.moneda || 'ARS';
  const prefix = moneda==='USD' ? 'U$D ' : '$ ';
  const fmt = n => (n && Number(n) > 0) ? prefix + Number(n).toLocaleString('es-AR') : 'â€”';
  const per = pg.periodo ? pg.periodo.split('-').reverse().join('/') : 'â€”';
  const hoy = new Date().toLocaleDateString('es-AR');

  const servicioRows = [
    {label:'Agua',        val:sv.agua},
    {label:'Luz',         val:sv.luz},
    {label:'Gas',         val:sv.gas},
    {label:'ContribuciÃ³n municipal', val:sv.municipal},
    {label:'Rentas provincial',      val:sv.rentas},
    {label:sv.otros_label||'Otros',  val:sv.otros},
  ].filter(s=>s.val>0);

  const totalSv = servicioRows.reduce((s,r)=>s+Number(r.val||0),0);
  const totalGeneral = Number(pg.monto||0) + totalSv;

  const svHTML = servicioRows.length ? servicioRows.map(s=>`
    <tr>
      <td style="padding:10px 16px;border-bottom:1px solid #e8e0d4;">${s.label}</td>
      <td style="padding:10px 16px;border-bottom:1px solid #e8e0d4;text-align:right;">${fmt(s.val)}</td>
    </tr>`).join('') : `<tr><td colspan="2" style="padding:10px 16px;color:#999;border-bottom:1px solid #e8e0d4;">Sin servicios cargados</td></tr>`;

  // NÃºmero de cupÃ³n
  const nContrato = String(emp.contrato_base || 1).padStart(4,'0');
  const nCuota    = String(emp.cuota_next    || 1).padStart(12,'0');
  const numCupon  = `${nContrato}-${nCuota}`;

  // Fecha de vencimiento del pago
  let fechaVto = 'â€”';
  if(c?.dia_pago && pg.periodo){
    const [ay,am] = pg.periodo.split('-');
    fechaVto = `${String(c.dia_pago).padStart(2,'0')}/${am}/${ay}`;
  }

  // Nombre del mes
  const meses = ['Enero','Febrero','Marzo','Abril','Mayo','Junio','Julio','Agosto','Septiembre','Octubre','Noviembre','Diciembre'];
  let periodoLabel = per;
  if(pg.periodo){ const [ay,am] = pg.periodo.split('-'); periodoLabel = `${meses[parseInt(am)-1]} - ${ay}`; }

  const html = `<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<title>CupÃ³n ${numCupon}</title>
<style>
  *{box-sizing:border-box;margin:0;padding:0;}
  body{font-family:'Helvetica Neue',Arial,sans-serif;background:#f2f2f2;min-height:100vh;display:flex;align-items:flex-start;justify-content:center;padding:40px 20px;}
  .cupon{background:white;width:680px;border:1px solid #ccc;box-shadow:0 2px 12px rgba(0,0,0,0.1);}
  .cabecera{padding:18px 24px;border-bottom:2px solid #1a1916;}
  .cabecera-grid{display:grid;grid-template-columns:1fr auto;gap:16px;align-items:start;}
  .razon-social{font-size:1rem;font-weight:700;color:#1a1916;margin-bottom:4px;}
  .cab-dato{font-size:0.78rem;color:#444;margin-bottom:2px;}
  .cab-derecha{text-align:right;border-left:1px solid #e0e0e0;padding-left:16px;}
  .cab-derecha .tipo{font-size:0.68rem;font-weight:700;text-transform:uppercase;letter-spacing:0.1em;color:#888;margin-bottom:4px;}
  .cab-derecha .num{font-size:1rem;font-weight:700;color:#1a1916;font-family:monospace;letter-spacing:0.05em;}
  .cab-derecha .fecha-linea{font-size:0.75rem;color:#666;margin-top:4px;}
  .invalido{background:#f8f8f8;border-bottom:1px solid #e0e0e0;text-align:center;padding:5px;font-size:0.68rem;color:#888;font-style:italic;letter-spacing:0.05em;}
  .cuerpo{padding:20px 24px;}
  .concepto-fila{display:flex;justify-content:space-between;align-items:center;padding:9px 12px;border-bottom:1px solid #f0f0f0;font-size:0.85rem;}
  .concepto-fila:nth-child(odd){background:#fafafa;}
  .concepto-fila.principal{font-weight:600;background:#fffbf4;}
  .concepto-fila.total-fila{background:#1a1916;color:white;font-weight:700;font-size:0.95rem;margin-top:2px;border-bottom:none;}
  .concepto-fila.total-fila span:last-child{color:#917860;font-size:1.05rem;}
  .concepto-header{display:flex;justify-content:space-between;font-size:0.68rem;font-weight:700;text-transform:uppercase;letter-spacing:0.08em;color:#888;padding:7px 12px;border-bottom:1px solid #ddd;background:#f5f5f5;}
  .datos-inquilino{display:grid;grid-template-columns:1fr 1fr;gap:8px;background:#f8f8f8;border-radius:4px;padding:12px;margin-bottom:16px;}
  .dato-item{font-size:0.78rem;} .dato-item label{color:#888;display:block;font-size:0.68rem;text-transform:uppercase;letter-spacing:0.06em;margin-bottom:2px;} .dato-item span{font-weight:500;color:#1a1916;}
  .nota{background:#fff8e8;border-left:3px solid #917860;padding:10px 14px;font-size:0.78rem;color:#555;margin-top:16px;line-height:1.6;}
  .pie{border-top:1px solid #e0e0e0;padding:12px 24px;display:flex;justify-content:space-between;align-items:center;background:#f8f8f8;}
  .pie p{font-size:0.7rem;color:#999;}
  .no-print{margin-left:12px;}
  @media print{
    body{background:white;padding:0;}
    .cupon{box-shadow:none;width:100%;border:none;}
    .no-print{display:none!important;}
  }
</style>
</head>
<body>
<div class="cupon">

  <div class="invalido">${emp.nota || 'Documento no vÃ¡lido como comprobante de pago'}</div>

  <div class="cabecera">
    <div class="cabecera-grid">
      <div>
        <div class="razon-social">${emp.razon || 'TerraLex'}</div>
        ${emp.domicilio ? `<div class="cab-dato">ğŸ“ ${emp.domicilio}</div>` : ''}
        ${emp.cuit     ? `<div class="cab-dato">CUIT: ${emp.cuit}</div>` : ''}
        ${emp.iva      ? `<div class="cab-dato">CondiciÃ³n IVA: ${emp.iva}</div>` : ''}
        ${emp.iibb     ? `<div class="cab-dato">Ingresos Brutos: ${emp.iibb}</div>` : ''}
        ${emp.inicio   ? `<div class="cab-dato">Inicio de Actividades: ${new Date(emp.inicio+'T12:00:00').toLocaleDateString('es-AR')}</div>` : ''}
      </div>
      <div class="cab-derecha">
        <div class="tipo">CupÃ³n de Pago</div>
        <div class="num">${numCupon}</div>
        <div class="fecha-linea">EmisiÃ³n: ${hoy}</div>
        <div class="fecha-linea">Vencimiento: ${fechaVto}</div>
      </div>
    </div>
  </div>

  <div class="cuerpo">
    <div class="datos-inquilino">
      <div class="dato-item"><label>Inquilino</label><span>${i?.nombre||'â€”'}</span></div>
      <div class="dato-item"><label>DNI / CUIT</label><span>${i?.dni||'â€”'}</span></div>
      <div class="dato-item"><label>Propiedad</label><span>${p?.direccion||'â€”'}${p?.piso?' Â· '+p.piso:''}</span></div>
      <div class="dato-item"><label>PerÃ­odo</label><span>${periodoLabel}</span></div>
      ${c?.expediente ? `<div class="dato-item"><label>NÂ° Expediente</label><span>${c.expediente}</span></div>` : ''}
      <div class="dato-item"><label>Propietario</label><span>${getPropietario(p?.propietario_id)?.nombre||'â€”'}</span></div>
    </div>

    <div class="concepto-header"><span>Concepto</span><span>Importe</span></div>
    <div class="concepto-fila principal">
      <span>Alquiler mensual â€” ${periodoLabel}</span>
      <span>${fmt(pg.monto)}</span>
    </div>
    ${svHTML}
    <div class="concepto-fila total-fila">
      <span>IMPORTE TOTAL</span>
      <span>${fmt(totalGeneral)}</span>
    </div>

    ${pg.notas ? `<div class="nota">ğŸ“‹ <strong>Nota:</strong> ${pg.notas}</div>` : ''}
  </div>

  <div class="pie">
    <p>CupÃ³n generado el ${hoy} Â· TerraLex${emp.tel ? ' Â· ' + emp.tel : ''}${emp.email ? ' Â· ' + emp.email : ''}</p>
    <button onclick="window.print()" class="no-print" style="background:#1a1916;color:#917860;border:none;padding:9px 18px;border-radius:6px;font-weight:700;cursor:pointer;font-size:0.82rem;">ğŸ–¨ï¸ Imprimir / PDF</button>
  </div>
</div>
</body>
</html>`;

  const win = window.open('','_blank');
  win.document.write(html);
  win.document.close();

  // Incrementar nÃºmero de cuota para el prÃ³ximo cupÃ³n
  if(emp.cuota_next){
    const nextNum = (parseInt(emp.cuota_next) || 1) + 1;
    try {
      await updateDoc(doc(db,'config','empresa'),{ cuota_next: nextNum });
      if(_empresaConfig) _empresaConfig.cuota_next = nextNum;
    } catch(e){}
  }
};

</script>
</body>
</html>
